<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>STACK ‚Äî by bbmw0</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="STACK">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0A0A1A">
<meta name="description" content="STACK ‚Äî the addictive block stacking game that transforms as you climb. How high can you go?">
<meta property="og:title" content="STACK ‚Äî by bbmw0">
<meta property="og:description" content="An addictive stacking game that transforms as you climb higher. Power-ups, phase shifts, and a global leaderboard. Can you reach the Cosmos?">
<meta property="og:type" content="website">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9IjYzMCIgdmlld0JveD0iMCAwIDEyMDAgNjMwIj48cmVjdCB3aWR0aD0iMTIwMCIgaGVpZ2h0PSI2MzAiIGZpbGw9IiMwQTBBMUEiLz48dGV4dCB4PSI2MDAiIHk9IjI4MCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9Im1vbm9zcGFjZSIgZm9udC1zaXplPSIxMjAiIGZvbnQtd2VpZ2h0PSJib2xkIiBmaWxsPSIjZmZmIj5TVEFDSzwvdGV4dD48dGV4dCB4PSI2MDAiIHk9IjM1MCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9Im1vbm9zcGFjZSIgZm9udC1zaXplPSIyNCIgZmlsbD0icmdiYSgyNTUsMjU1LDI1NSwwLjQpIj5ieSBiYm13MDwvdGV4dD48cmVjdCB4PSI0MDAiIHk9IjQyMCIgd2lkdGg9IjQwMCIgaGVpZ2h0PSI0MCIgcng9IjUiIGZpbGw9IiNGRjZCNkIiLz48cmVjdCB4PSI0MjAiIHk9IjM3OCIgd2lkdGg9IjM2MCIgaGVpZ2h0PSI0MCIgcng9IjUiIGZpbGw9IiNGRjhFNTMiLz48cmVjdCB4PSI0NDAiIHk9IjMzNiIgd2lkdGg9IjMyMCIgaGVpZ2h0PSI0MCIgcng9IjUiIGZpbGw9IiNGRkM1M0QiLz48L3N2Zz4=">
<link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxODAiIGhlaWdodD0iMTgwIj48cmVjdCB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgcng9IjQwIiBmaWxsPSIjMEEwQTFBIi8+PHJlY3QgeD0iMzAiIHk9IjExNSIgd2lkdGg9IjEyMCIgaGVpZ2h0PSIyNCIgcng9IjQiIGZpbGw9IiNGRjZCNkIiLz48cmVjdCB4PSIzOCIgeT0iODkiIHdpZHRoPSIxMDQiIGhlaWdodD0iMjQiIHJ4PSI0IiBmaWxsPSIjRkY4RTUzIi8+PHJlY3QgeD0iNDYiIHk9IjYzIiB3aWR0aD0iODgiIGhlaWdodD0iMjQiIHJ4PSI0IiBmaWxsPSIjRkZDNTNEIi8+PHJlY3QgeD0iNTQiIHk9IjM3IiB3aWR0aD0iNzIiIGhlaWdodD0iMjQiIHJ4PSI0IiBmaWxsPSIjNTFDRjY2Ii8+PC9zdmc+">
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;background:#0A0A1A;font-family:'Courier New',Courier,monospace;-webkit-user-select:none;user-select:none;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none}
#app{width:100%;height:100dvh;position:relative;overflow:hidden;touch-action:manipulation}
canvas{display:block;width:100%;height:100%;position:absolute;top:0;left:0}
.no-touch{pointer-events:none}

/* TAP LAYER ‚Äî catches all game taps */
#tapLayer{position:absolute;inset:0;z-index:5}

/* HUD */
.hud{position:absolute;top:env(safe-area-inset-top,16px);left:0;right:0;padding:14px 20px;display:flex;justify-content:space-between;align-items:flex-start;z-index:12;pointer-events:none}
.hud-l{color:rgba(255,255,255,0.3);font-size:9px;letter-spacing:3px;text-transform:uppercase}
.hud-sc{color:#fff;font-size:42px;font-weight:bold;line-height:1;text-shadow:0 0 20px rgba(255,107,107,0.4)}
.hud-bs{color:rgba(255,255,255,0.45);font-size:20px;font-weight:bold;line-height:1}
.hud-pbtn{pointer-events:all;cursor:pointer;width:34px;height:34px;border-radius:50%;background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.1);display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,0.45);font-size:13px;font-weight:bold;margin-top:4px}

/* Phase label */
.phase-lbl{position:absolute;top:env(safe-area-inset-top,16px);left:50%;transform:translateX(-50%);z-index:12;pointer-events:none;font-size:9px;letter-spacing:4px;text-transform:uppercase;transition:all 0.6s;opacity:0.5}

/* Power-up pill */
.pu-pill{position:absolute;bottom:80px;left:50%;transform:translateX(-50%);z-index:12;pointer-events:none;padding:7px 18px;border-radius:20px;font-size:11px;font-weight:bold;letter-spacing:2px;opacity:0;transition:opacity 0.3s}
.pu-pill.on{opacity:1}

/* Combo */
.combo-lbl{position:absolute;top:95px;left:50%;transform:translateX(-50%);z-index:12;pointer-events:none;font-size:15px;font-weight:bold;opacity:0;transition:opacity 0.2s;text-shadow:0 0 12px currentColor}
.combo-lbl.on{opacity:1}

/* Big flash text */
.flash-txt{position:absolute;top:36%;left:50%;transform:translate(-50%,-50%);z-index:12;pointer-events:none;color:#fff;font-size:24px;font-weight:bold;letter-spacing:10px;text-shadow:0 0 30px rgba(255,255,255,0.6);opacity:0;transition:opacity 0.12s}
.flash-txt.on{opacity:0.9}

/* Phase announce */
.phase-ann{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%) scale(0.6);z-index:14;pointer-events:none;text-align:center;opacity:0;transition:all 0.5s cubic-bezier(0.175,0.885,0.32,1.275)}
.phase-ann.on{opacity:1;transform:translate(-50%,-50%) scale(1)}
.phase-ann-name{font-size:36px;font-weight:bold;color:#fff;text-shadow:0 0 40px currentColor;letter-spacing:6px}
.phase-ann-sub{font-size:11px;letter-spacing:4px;margin-top:6px;opacity:0.4}

/* ‚ïê‚ïê‚ïê OVERLAYS ‚ïê‚ïê‚ïê */
.ov{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:20;background:rgba(10,10,26,0.94);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);transition:opacity 0.3s}
.ov.hide{opacity:0;pointer-events:none}

/* Start */
.s-title{font-size:56px;font-weight:bold;color:#fff;letter-spacing:10px;text-shadow:0 0 50px rgba(255,107,107,0.5),0 0 100px rgba(255,107,107,0.2);margin-bottom:4px}
.s-sub{color:rgba(255,255,255,0.25);font-size:11px;letter-spacing:6px;margin-bottom:6px}
.s-ver{color:rgba(255,255,255,0.12);font-size:9px;letter-spacing:2px;margin-bottom:36px}
.s-circle{width:72px;height:72px;border-radius:50%;border:2px solid rgba(255,255,255,0.12);display:flex;align-items:center;justify-content:center;animation:breathe 2s infinite ease-in-out;cursor:pointer}
.s-dot{width:14px;height:14px;border-radius:50%;background:#FF6B6B;box-shadow:0 0 20px rgba(255,107,107,0.5)}
.s-tap{color:rgba(255,255,255,0.18);font-size:10px;letter-spacing:3px;margin-top:18px}
.s-by{color:rgba(255,255,255,0.15);font-size:10px;letter-spacing:2px;margin-top:28px}
.s-nav{position:absolute;bottom:env(safe-area-inset-bottom,30px);display:flex;gap:14px;padding-bottom:10px}
.s-btn{color:rgba(255,255,255,0.28);font-size:10px;letter-spacing:2px;cursor:pointer;padding:9px 18px;border:1px solid rgba(255,255,255,0.07);border-radius:22px;font-family:inherit;background:none}
.s-btn:active{background:rgba(255,255,255,0.05)}
.s-share-btn{padding:9px 18px;border:1px solid rgba(255,107,107,0.15);border-radius:22px;background:rgba(255,107,107,0.06);color:rgba(255,107,107,0.6);font-size:10px;letter-spacing:2px;cursor:pointer;font-family:inherit;display:flex;align-items:center;gap:6px}
.s-share-btn:active{background:rgba(255,107,107,0.12)}

/* Game Over */
.g-lbl{color:rgba(255,255,255,0.3);font-size:11px;letter-spacing:5px;text-transform:uppercase;margin-bottom:10px}
.g-sc{font-size:76px;font-weight:bold;color:#fff;line-height:1;text-shadow:0 0 30px rgba(255,107,107,0.4)}
.g-new{color:#FFC53D;font-size:12px;letter-spacing:3px;text-shadow:0 0 10px rgba(255,197,61,0.4);margin-top:6px}
.g-new.hide{display:none}
.g-best{color:rgba(255,255,255,0.25);font-size:13px;margin-top:6px}
.g-phase{color:rgba(255,255,255,0.18);font-size:10px;letter-spacing:2px;margin:6px 0}
.g-row{display:flex;gap:30px;margin:12px 0}
.g-sl{color:rgba(255,255,255,0.25);font-size:9px;letter-spacing:2px;text-transform:uppercase;text-align:center}
.g-sv{color:rgba(255,255,255,0.65);font-size:20px;font-weight:bold;text-align:center;margin-top:3px}
.g-xp{color:rgba(255,255,255,0.2);font-size:10px;letter-spacing:1px;margin-bottom:16px}
.g-xp span{color:#51CF66}
.g-btns{display:flex;gap:12px}
.g-btn{padding:13px 30px;border:1px solid rgba(255,255,255,0.1);border-radius:26px;color:rgba(255,255,255,0.45);font-size:11px;letter-spacing:3px;text-transform:uppercase;font-family:inherit;cursor:pointer;background:none}
.g-btn:active{background:rgba(255,255,255,0.05)}
.g-btn.pri{border-color:rgba(255,107,107,0.25);color:rgba(255,107,107,0.75)}
.g-btn.pri:active{background:rgba(255,107,107,0.08)}
.g-share{margin-top:10px;padding:9px 24px;border:1px solid rgba(255,255,255,0.05);border-radius:20px;color:rgba(255,255,255,0.2);font-size:9px;letter-spacing:2px;cursor:pointer;background:none;font-family:inherit}

/* Profile - scrollable */
.prof{overflow-y:auto;padding:60px 20px 40px;align-items:stretch;justify-content:flex-start;-webkit-overflow-scrolling:touch}
.p-close{position:absolute;top:env(safe-area-inset-top,14px);right:14px;width:38px;height:38px;border-radius:50%;background:rgba(255,255,255,0.06);border:none;color:rgba(255,255,255,0.35);font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-family:inherit;z-index:2}
.p-hdr{text-align:center;margin-bottom:28px}
.p-av{width:64px;height:64px;border-radius:50%;background:linear-gradient(135deg,#FF6B6B,#845EF7);display:flex;align-items:center;justify-content:center;margin:0 auto 10px;font-size:26px;font-weight:bold;color:#fff}
.p-nm{color:#fff;font-size:18px;font-weight:bold;letter-spacing:2px}
.p-lv{color:rgba(255,255,255,0.3);font-size:10px;letter-spacing:2px;margin-top:3px}
.p-xpb{width:180px;height:3px;background:rgba(255,255,255,0.07);border-radius:2px;margin:7px auto 0;overflow:hidden}
.p-xpf{height:100%;background:linear-gradient(90deg,#51CF66,#339AF0);border-radius:2px;transition:width 0.4s}
.sec{color:rgba(255,255,255,0.25);font-size:9px;letter-spacing:3px;text-transform:uppercase;margin:22px 0 10px;padding-left:2px}
.sg{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.sc{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.05);border-radius:10px;padding:12px;text-align:center}
.sc-v{color:#fff;font-size:22px;font-weight:bold}
.sc-l{color:rgba(255,255,255,0.25);font-size:8px;letter-spacing:2px;text-transform:uppercase;margin-top:3px}
.ag{display:flex;flex-direction:column;gap:6px}
.ar{display:flex;align-items:center;gap:10px;padding:10px 12px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.04);border-radius:8px}
.ar.lk{opacity:0.3}
.ll{display:flex;flex-direction:column;gap:5px}
.lr{display:flex;align-items:center;gap:10px;padding:9px 12px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.04);border-radius:8px}
.lr.you{border-color:rgba(255,107,107,0.15);background:rgba(255,107,107,0.04)}
.gs{display:flex;gap:8px;margin-bottom:14px}
.gi{flex:1;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.08);border-radius:8px;padding:9px 12px;color:#fff;font-family:inherit;font-size:12px;outline:none}
.gi::placeholder{color:rgba(255,255,255,0.18)}
.gsv{background:rgba(255,107,107,0.12);border:1px solid rgba(255,107,107,0.18);border-radius:8px;padding:9px 14px;color:#FF6B6B;font-family:inherit;font-size:11px;font-weight:bold;cursor:pointer}
.lb{display:flex;flex-direction:column;gap:8px}
.lbtn{display:flex;align-items:center;justify-content:center;gap:8px;padding:12px 18px;border-radius:10px;border:1px solid rgba(255,255,255,0.08);font-family:inherit;font-size:12px;font-weight:bold;letter-spacing:1px;cursor:pointer}
.lbtn.gg{background:rgba(255,255,255,0.93);color:#333}
.lbtn.ap{background:#000;color:#fff;border-color:rgba(255,255,255,0.15)}
.lbtn.li{background:#0A66C2;color:#fff;border-color:transparent}
.lbtn svg{flex-shrink:0}
.ln{color:rgba(255,255,255,0.12);font-size:8px;text-align:center;margin-top:8px;letter-spacing:1px}
.rst{margin-top:18px;padding:9px 18px;border:1px solid rgba(255,60,60,0.12);border-radius:8px;background:none;color:rgba(255,60,60,0.35);font-size:9px;letter-spacing:2px;cursor:pointer;font-family:inherit;text-transform:uppercase;align-self:center}

/* Achievement toast */
.ach{position:absolute;top:60px;left:50%;transform:translateX(-50%) translateY(-80px);z-index:30;background:rgba(25,25,45,0.95);border:1px solid rgba(255,197,61,0.25);border-radius:10px;padding:10px 16px;display:flex;align-items:center;gap:8px;opacity:0;transition:all 0.4s ease;pointer-events:none}
.ach.on{transform:translateX(-50%) translateY(0);opacity:1}

@keyframes breathe{0%,100%{transform:scale(1);opacity:0.5}50%{transform:scale(1.12);opacity:1}}
</style>
</head>
<body>
<div id="app">
  <canvas id="c"></canvas>
  <div id="tapLayer"></div>

  <div class="hud no-touch" id="hud" style="display:none">
    <div><div class="hud-l">Score</div><div class="hud-sc" id="dSc">0</div></div>
    <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
      <div><div class="hud-l" style="text-align:right">Best</div><div class="hud-bs" id="dBs">0</div></div>
      <div class="hud-pbtn" id="btnProf" style="pointer-events:all">?</div>
    </div>
  </div>
  <div class="phase-lbl no-touch" id="dPhase"></div>
  <div class="pu-pill no-touch" id="dPu"></div>
  <div class="combo-lbl no-touch" id="dCo"></div>
  <div class="flash-txt no-touch" id="dFlash">PERFECT</div>
  <div class="phase-ann no-touch" id="dPAnn"><div class="phase-ann-name" id="dPAnnN"></div><div class="phase-ann-sub" id="dPAnnS"></div></div>
  <div class="ach no-touch" id="dAch"><div id="dAchI" style="font-size:20px">üèÜ</div><div><div style="color:rgba(255,197,61,0.5);font-size:8px;letter-spacing:2px">ACHIEVEMENT</div><div id="dAchN" style="color:#fff;font-size:12px;font-weight:bold;margin-top:1px">‚Äî</div></div></div>

  <!-- ‚ïê‚ïê‚ïê START ‚ïê‚ïê‚ïê -->
  <div class="ov" id="ovStart">
    <div class="s-title">STACK</div>
    <div class="s-sub">TAP TO DROP</div>
    <div class="s-ver">v2.0</div>
    <div class="s-circle" id="startCircle"><div class="s-dot"></div></div>
    <div class="s-tap">TAP ANYWHERE</div>
    <div class="s-by">created by bbmw0</div>
    <div class="s-nav">
      <button class="s-btn" id="btnNavProf">PROFILE</button>
      <button class="s-share-btn" id="btnShareLink">‚Üó SHARE GAME</button>
      <button class="s-btn" id="btnNavRank">RANKS</button>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê GAME OVER ‚ïê‚ïê‚ïê -->
  <div class="ov hide" id="ovGo">
    <div class="g-lbl">Game Over</div>
    <div class="g-sc" id="gSc">0</div>
    <div class="g-new hide" id="gNew">‚òÖ NEW BEST ‚òÖ</div>
    <div class="g-best" id="gBs">Best: 0</div>
    <div class="g-phase" id="gPh"></div>
    <div class="g-row">
      <div><div class="g-sl">Combo</div><div class="g-sv" id="gCo">0</div></div>
      <div><div class="g-sl">Perfects</div><div class="g-sv" id="gPf">0</div></div>
      <div><div class="g-sl">Games</div><div class="g-sv" id="gGp">0</div></div>
    </div>
    <div class="g-xp" id="gXp">+<span>0</span> XP</div>
    <div class="g-btns">
      <button class="g-btn pri" id="btnRetry">RETRY</button>
      <button class="g-btn" id="btnHome">HOME</button>
    </div>
    <button class="g-share" id="btnShareScore">SHARE SCORE</button>
  </div>

  <!-- ‚ïê‚ïê‚ïê PROFILE ‚ïê‚ïê‚ïê -->
  <div class="ov hide prof" id="ovProf">
    <button class="p-close" id="btnProfX">‚úï</button>
    <div class="p-hdr"><div class="p-av" id="pAv">?</div><div class="p-nm" id="pNm">Guest</div><div class="p-lv" id="pLv">Level 1</div><div class="p-xpb"><div class="p-xpf" id="pXp" style="width:0%"></div></div></div>
    <div class="sec">Player Name</div>
    <div class="gs"><input type="text" class="gi" id="pNI" placeholder="Enter your name..." maxlength="16"><button class="gsv" id="btnNSave">SAVE</button></div>
    <div class="sec">Statistics</div>
    <div class="sg"><div class="sc"><div class="sc-v" id="s1">0</div><div class="sc-l">Best Score</div></div><div class="sc"><div class="sc-v" id="s2">0</div><div class="sc-l">Games</div></div><div class="sc"><div class="sc-v" id="s3">0</div><div class="sc-l">Perfects</div></div><div class="sc"><div class="sc-v" id="s4">0</div><div class="sc-l">Best Combo</div></div><div class="sc"><div class="sc-v" id="s5">0</div><div class="sc-l">Avg Score</div></div><div class="sc"><div class="sc-v" id="s6">0</div><div class="sc-l">Total XP</div></div></div>
    <div class="sec">Achievements</div>
    <div class="ag" id="aG"></div>
    <div class="sec">Leaderboard</div>
    <div class="ll" id="lL"></div>
    <div class="sec">Sign In to Sync</div>
    <div style="color:rgba(255,255,255,0.2);font-size:9px;line-height:1.6;margin-bottom:12px;text-align:center">Save your progress across devices</div>
    <div class="lb">
      <button class="lbtn gg" id="bG"><svg width="16" height="16" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>Google</button>
      <button class="lbtn ap" id="bA"><svg width="16" height="16" viewBox="0 0 24 24" fill="white"><path d="M17.05 20.28c-.98.95-2.05.88-3.08.4-1.09-.5-2.08-.48-3.24 0-1.44.62-2.2.44-3.06-.4C2.79 15.25 3.51 7.59 9.05 7.31c1.35.07 2.29.74 3.08.8 1.18-.24 2.31-.93 3.57-.84 1.51.12 2.65.72 3.4 1.8-3.12 1.87-2.38 5.98.48 7.13-.57 1.5-1.31 2.99-2.54 4.09zM12.03 7.25c-.15-2.23 1.66-4.07 3.74-4.25.29 2.58-2.34 4.5-3.74 4.25z"/></svg>Apple</button>
      <button class="lbtn li" id="bL"><svg width="16" height="16" viewBox="0 0 24 24" fill="white"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>LinkedIn</button>
    </div>
    <div class="ln">Backend integration required for sign-in</div>
    <button class="rst" id="btnRst">RESET ALL DATA</button>
  </div>
</div>

<script>
(function(){
"use strict";
const $=id=>document.getElementById(id);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONSTANTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const BH=28,BW=110,SI=2.0,SINC=0.1,SMAX=11,PT=5,GR=0.55;

// ‚ïê‚ïê‚ïê PHASES ‚Äî game transforms as you climb ‚ïê‚ïê‚ïê
const PHASES=[
  {id:"classic",name:"CLASSIC",sub:"Stack it up",from:0,to:7,
   bg1:"#0A0A1A",bg2:"#151528",colors:["#FF6B6B","#FF8E53","#FFC53D","#51CF66","#339AF0","#845EF7"],
   stars:0,speedMul:1,blockMul:1,glow:8},
  {id:"neon",name:"NEON RUSH",sub:"Blocks leave trails",from:8,to:15,
   bg1:"#0D0025",bg2:"#1A003A",colors:["#00F5FF","#00FF87","#FF00E5","#FFE500","#FF6B6B","#7B61FF"],
   stars:10,speedMul:1.1,blockMul:1,glow:18,trail:true},
  {id:"dual",name:"DUAL SPEED",sub:"Fast-slow-fast",from:16,to:24,
   bg1:"#1A0A00",bg2:"#2D1500",colors:["#FF922B","#FFC53D","#FF6B6B","#F06595","#E599F7","#FFE066"],
   stars:20,speedMul:1,blockMul:0.95,glow:12,dualSpeed:true},
  {id:"precision",name:"PRECISION",sub:"Blocks shrink ‚Äî stay focused",from:25,to:39,
   bg1:"#000A1A",bg2:"#001530",colors:["#339AF0","#5C7CFA","#845EF7","#3BC9DB","#22B8CF","#66D9E8"],
   stars:35,speedMul:1.15,blockMul:0.88,glow:14},
  {id:"hyper",name:"HYPERDRIVE",sub:"Maximum velocity",from:40,to:59,
   bg1:"#0A000A",bg2:"#1A0020",colors:["#FF6B6B","#F06595","#E599F7","#B197FC","#845EF7","#FFC53D"],
   stars:60,speedMul:1.3,blockMul:0.85,glow:20},
  {id:"cosmos",name:"COSMOS",sub:"Beyond everything",from:60,to:9999,
   bg1:"#000000",bg2:"#050008",colors:["#FFFFFF","#FFC53D","#FF6B6B","#00F5FF","#51CF66","#E599F7"],
   stars:120,speedMul:1.4,blockMul:0.82,glow:25},
];
function getPhase(sc){return PHASES.find(p=>sc>=p.from&&sc<=p.to)||PHASES[0]}

// ‚ïê‚ïê‚ïê POWER-UPS ‚ïê‚ïê‚ïê
const PUS=[
  {id:"wide",lbl:"‚¨õ WIDER",col:"#51CF66",bg:"rgba(81,207,102,0.12)",bdr:"rgba(81,207,102,0.25)"},
  {id:"slow",lbl:"üê¢ SLOW-MO",col:"#339AF0",bg:"rgba(51,154,240,0.12)",bdr:"rgba(51,154,240,0.25)"},
  {id:"magnet",lbl:"üß≤ MAGNET",col:"#E599F7",bg:"rgba(229,153,247,0.12)",bdr:"rgba(229,153,247,0.25)"},
  {id:"shield",lbl:"üõ°Ô∏è SHIELD",col:"#FFC53D",bg:"rgba(255,197,61,0.12)",bdr:"rgba(255,197,61,0.25)"},
];

// ‚ïê‚ïê‚ïê ACHIEVEMENTS ‚ïê‚ïê‚ïê
const ACHS=[
  {id:"f",i:"üéØ",n:"First Stack",d:"Complete a game",ck:d=>d.gp>=1},
  {id:"10",i:"üîü",n:"Double Digits",d:"Score 10",ck:d=>d.bs>=10},
  {id:"25",i:"üåü",n:"Quarter Century",d:"Score 25",ck:d=>d.bs>=25},
  {id:"50",i:"üî•",n:"Fifty Stack",d:"Score 50",ck:d=>d.bs>=50},
  {id:"100",i:"üíé",n:"Centurion",d:"Score 100",ck:d=>d.bs>=100},
  {id:"c3",i:"‚ö°",n:"Triple Threat",d:"3√ó perfect combo",ck:d=>d.bc>=3},
  {id:"c5",i:"üåä",n:"On Fire",d:"5√ó combo",ck:d=>d.bc>=5},
  {id:"c10",i:"‚òÑÔ∏è",n:"Unstoppable",d:"10√ó combo",ck:d=>d.bc>=10},
  {id:"g10",i:"üéÆ",n:"Regular",d:"Play 10 games",ck:d=>d.gp>=10},
  {id:"g50",i:"üèÖ",n:"Dedicated",d:"Play 50 games",ck:d=>d.gp>=50},
  {id:"neo",i:"üíú",n:"Neon Runner",d:"Reach Neon Rush",ck:d=>d.bs>=8},
  {id:"hyp",i:"üöÄ",n:"Hyperdrive",d:"Reach Hyperdrive",ck:d=>d.bs>=40},
  {id:"cos",i:"üåå",n:"Cosmic",d:"Reach the Cosmos",ck:d=>d.bs>=60},
];

// ‚ïê‚ïê‚ïê SAVE ‚ïê‚ïê‚ïê
const DEF={name:"Guest",bs:0,gp:0,tp:0,bc:0,ts:0,xp:0,ach:[]};
function ld(){try{const r=localStorage.getItem("stk3");if(r)return{...DEF,...JSON.parse(r)}}catch(e){}return{...DEF}}
function sv(d){try{localStorage.setItem("stk3",JSON.stringify(d))}catch(e){}}
let D=ld();
function xpFor(l){return l*l*50}
function getLv(x){let l=1;while(x>=xpFor(l))l++;return l}
function getLvP(x){const l=getLv(x),p=xpFor(l-1),n=xpFor(l);return l===1?x/n:(x-p)/(n-p)}

// ‚ïê‚ïê‚ïê CANVAS ‚ïê‚ïê‚ïê
const canvas=$("c"),ctx=canvas.getContext("2d");
let W,H,dpr;
function resize(){dpr=window.devicePixelRatio||1;W=window.innerWidth;H=window.innerHeight;canvas.width=W*dpr;canvas.height=H*dpr;ctx.setTransform(dpr,0,0,dpr,0,0)}
window.addEventListener("resize",resize);resize();

// ‚ïê‚ïê‚ïê AUDIO ‚ïê‚ïê‚ïê
let ac=null;
function initA(){if(!ac)ac=new(window.AudioContext||window.webkitAudioContext)();if(ac.state==="suspended")ac.resume()}
function tone(f,d,v){if(!ac)return;const o=ac.createOscillator(),g=ac.createGain();o.type="sine";o.frequency.value=f;g.gain.setValueAtTime(v||0.1,ac.currentTime);g.gain.exponentialRampToValueAtTime(0.001,ac.currentTime+d);o.connect(g);g.connect(ac.destination);o.start();o.stop(ac.currentTime+d)}
function sndPlace(co){const b=300+Math.min(co,12)*40;tone(b,0.12,0.08);if(co>=2)tone(b*1.5,0.18,0.06)}
function sndFail(){tone(150,0.3,0.12);setTimeout(()=>tone(100,0.35,0.08),100)}
function sndPhase(){[523,659,784,1047].forEach((f,i)=>setTimeout(()=>tone(f,0.12,0.08),i*100))}
function sndPU(){tone(800,0.08,0.06);setTimeout(()=>tone(1200,0.1,0.08),100)}
function vib(p){if(navigator.vibrate)navigator.vibrate(p)}

// ‚ïê‚ïê‚ïê STARS ‚ïê‚ïê‚ïê
let stars=[];
function genStars(n){stars=[];for(let i=0;i<n;i++)stars.push({x:Math.random()*W,y:Math.random()*H,s:Math.random()*1.8+0.3,b:Math.random(),sp:Math.random()*0.004+0.001})}

// ‚ïê‚ïê‚ïê GAME STATE ‚ïê‚ïê‚ïê
let S=null,running=false,animId=null,curPhaseId="",tick=0;

function mkS(){return{
  stack:[{x:(W-BW)/2,w:BW,color:PHASES[0].colors[0]}],
  mov:null,fall:[],parts:[],fire:[],trails:[],cam:0,sc:0,co:0,mc:0,pf:0,
  over:false,flash:0,shk:0,
  pu:null,puT:0,puNext:Math.floor(Math.random()*6)+6,
  shield:false,dualTick:0
}}
function spawn(s){
  const ph=getPhase(s.sc);
  const top=s.stack[s.stack.length-1];
  const ci=s.stack.length%ph.colors.length;
  let spd=Math.min(SI+s.sc*SINC,SMAX)*ph.speedMul;
  if(ph.dualSpeed){s.dualTick++;spd*=(s.dualTick%2===0)?0.6:1.5}
  const dir=s.sc%2===0?1:-1;
  let w=top.w*ph.blockMul;
  w=Math.max(w,top.w);// don't shrink below current
  if(s.pu==="wide")w=Math.min(w+28,BW*1.35);
  s.mov={x:dir===1?-w-20:W+20,w,dir,speed:spd,color:ph.colors[ci]}
}

// ‚ïê‚ïê‚ïê GAME ACTIONS ‚ïê‚ïê‚ïê
function startGame(){
  initA();S=mkS();spawn(S);running=true;curPhaseId="";tick=0;
  genStars(0);
  $("hud").style.display="flex";
  $("ovStart").classList.add("hide");$("ovGo").classList.add("hide");$("ovProf").classList.add("hide");
  $("tapLayer").style.display="block";
  $("dSc").textContent="0";$("dBs").textContent=D.bs;
  $("dCo").classList.remove("on");$("dFlash").classList.remove("on");$("dPhase").textContent="";
  $("dPu").classList.remove("on");
  updAv();if(!animId)loop();
}

function goHome(){
  running=false;S=null;if(animId){cancelAnimationFrame(animId);animId=null}
  $("hud").style.display="none";$("ovGo").classList.add("hide");$("ovStart").classList.remove("hide");
  $("tapLayer").style.display="none";$("dPhase").textContent="";$("dPu").classList.remove("on");
}

function gameTap(){
  if(!S||S.over||!running)return;
  drop();
}

function drop(){
  if(!S||S.over)return;
  const s=S,top=s.stack[s.stack.length-1],m=s.mov;
  const oS=Math.max(top.x,m.x),oE=Math.min(top.x+top.w,m.x+m.w);
  let oW=oE-oS;

  // Magnet snap
  if(s.pu==="magnet"&&oW>0&&Math.abs(m.x-top.x)<22){
    s.stack.push({x:top.x,w:top.w,color:m.color});s.co++;s.pf++;if(s.co>s.mc)s.mc=s.co;s.flash=22;
    mkParts(s,top);vib(10);showFlash("PERFECT");afterPlace(s,true);return;
  }

  // Shield save
  if(oW<=0&&s.shield){s.shield=false;$("dPu").classList.remove("on");
    s.stack.push({x:top.x,w:Math.max(top.w*0.6,20),color:m.color});s.co=0;s.sc++;
    showFlash("SAVED!");$("dSc").textContent=s.sc;sndPU();spawn(s);return;
  }

  if(oW<=0){
    s.over=true;s.fall.push({x:m.x,w:m.w,y:0,vy:0,rot:0,vr:(Math.random()-0.5)*0.08,color:m.color});
    sndFail();vib([50,30,50]);s.shk=10;endGame(s);return;
  }

  const perf=Math.abs(m.x-top.x)<PT&&Math.abs(m.w-top.w)<PT;
  if(perf){
    s.stack.push({x:top.x,w:top.w,color:m.color});s.co++;s.pf++;if(s.co>s.mc)s.mc=s.co;s.flash=22;
    mkParts(s,top);vib(10);showFlash(s.co>=3?"üî• PERFECT":"PERFECT");
  }else{
    s.stack.push({x:oS,w:oW,color:m.color});s.co=0;
    if(m.x<top.x)s.fall.push({x:m.x,w:top.x-m.x,y:0,vy:0,rot:0,vr:-0.03,color:m.color});
    if(m.x+m.w>top.x+top.w)s.fall.push({x:top.x+top.w,w:(m.x+m.w)-(top.x+top.w),y:0,vy:0,rot:0,vr:0.03,color:m.color});
    vib(5);
  }
  afterPlace(s,perf);
}

function afterPlace(s,perf){
  s.sc++;$("dSc").textContent=s.sc;sndPlace(s.co);

  // Combo
  if(s.co>=2){$("dCo").classList.add("on");$("dCo").style.color=getPhase(s.sc).colors[0];$("dCo").textContent="üî• √ó"+s.co+" PERFECT"}
  else $("dCo").classList.remove("on");

  // Fire on high combos
  if(s.co>=3){const t=s.stack[s.stack.length-1];for(let i=0;i<8;i++)s.fire.push({x:t.x+Math.random()*t.w,y:H-50-(s.stack.length-1)*BH+s.cam,life:1,vx:(Math.random()-0.5)*2.5,vy:-Math.random()*3.5-1.5,sz:Math.random()*6+3})}

  // Phase change
  const ph=getPhase(s.sc);
  if(ph.id!==curPhaseId){curPhaseId=ph.id;$("dPhase").textContent=ph.name;$("dPhase").style.color=ph.colors[0];
    genStars(ph.stars);showPhaseAnn(ph);sndPhase()}

  // Neon trails
  if(ph.trail){const t=s.stack[s.stack.length-1];s.trails.push({x:t.x,w:t.w,y:H-50-(s.stack.length-1)*BH+s.cam,color:s.mov?s.mov.color:ph.colors[0],life:1})}

  // Milestone
  if(s.sc%10===0&&s.sc>0)showFlash("‚Äî "+s.sc+" ‚Äî");

  // Power-up
  if(s.sc>=s.puNext&&!s.pu&&!s.shield){
    const pu=PUS[Math.floor(Math.random()*PUS.length)];
    if(pu.id==="shield"){s.shield=true;s.puNext=s.sc+Math.floor(Math.random()*12)+10}
    else{s.pu=pu.id;s.puT=pu.id==="slow"?8:pu.id==="magnet"?5:1;s.puNext=s.sc+Math.floor(Math.random()*10)+8}
    $("dPu").textContent=pu.lbl;$("dPu").style.background=pu.bg;$("dPu").style.border="1px solid "+pu.bdr;$("dPu").style.color=pu.col;$("dPu").classList.add("on");sndPU();
  }
  if(s.pu){s.puT--;if(s.puT<=0){s.pu=null;$("dPu").classList.remove("on")}}

  spawn(s);
  if(perf&&s.co>=2)s.mov.w=Math.min(s.stack[s.stack.length-1].w+s.co*1.2,BW*1.3);
}

function mkParts(s,t){for(let i=0;i<16;i++)s.parts.push({x:t.x+t.w/2+(Math.random()-0.5)*t.w*0.8,y:H-50-(s.stack.length-1)*BH+s.cam,vx:(Math.random()-0.5)*7,vy:-Math.random()*5-2,life:1,color:s.mov?s.mov.color:"#fff",sz:Math.random()*4+2})}

function showFlash(txt){$("dFlash").textContent=txt;$("dFlash").classList.add("on");clearTimeout(showFlash._t);showFlash._t=setTimeout(()=>$("dFlash").classList.remove("on"),350)}
let pAnnT=null;
function showPhaseAnn(ph){$("dPAnnN").textContent=ph.name;$("dPAnnN").style.textShadow="0 0 40px "+ph.colors[0];$("dPAnnS").textContent=ph.sub;$("dPAnn").classList.add("on");if(pAnnT)clearTimeout(pAnnT);pAnnT=setTimeout(()=>$("dPAnn").classList.remove("on"),1500)}

function endGame(s){
  const xp=s.sc*10+s.pf*5+s.mc*8;const isNew=s.sc>D.bs;
  D.gp++;D.ts+=s.sc;D.tp+=s.pf;D.xp+=xp;if(s.sc>D.bs)D.bs=s.sc;if(s.mc>D.bc)D.bc=s.mc;
  const nA=[];ACHS.forEach(a=>{if(!D.ach.includes(a.id)&&a.ck(D)){D.ach.push(a.id);nA.push(a)}});sv(D);
  const ph=getPhase(s.sc);
  $("gSc").textContent=s.sc;$("gBs").textContent="Best: "+D.bs;$("gCo").textContent=s.mc;$("gPf").textContent=s.pf;
  $("gGp").textContent=D.gp;$("gXp").innerHTML="+<span>"+xp+"</span> XP";$("dBs").textContent=D.bs;
  $("gPh").textContent="Reached: "+ph.name;
  if(isNew&&s.sc>0)$("gNew").classList.remove("hide");else $("gNew").classList.add("hide");
  $("dCo").classList.remove("on");$("dPu").classList.remove("on");$("tapLayer").style.display="none";
  setTimeout(()=>$("ovGo").classList.remove("hide"),450);
  nA.forEach((a,i)=>setTimeout(()=>showAchToast(a),700+i*2200));
}

let achTO=null;
function showAchToast(a){$("dAchI").textContent=a.i;$("dAchN").textContent=a.n;$("dAch").classList.add("on");if(achTO)clearTimeout(achTO);achTO=setTimeout(()=>$("dAch").classList.remove("on"),2500);tone(523,0.08,0.06);setTimeout(()=>tone(784,0.12,0.08),150)}

// ‚ïê‚ïê‚ïê PROFILE ‚ïê‚ïê‚ïê
function openProf(){$("ovProf").classList.remove("hide");$("ovStart").classList.add("hide");$("ovGo").classList.add("hide");$("tapLayer").style.display="none";rProf()}
function closeProf(){$("ovProf").classList.add("hide");if(running&&S&&!S.over){$("hud").style.display="flex";$("tapLayer").style.display="block"}else $("ovStart").classList.remove("hide")}
function rProf(){
  const l=getLv(D.xp),p=getLvP(D.xp);
  $("pAv").textContent=D.name==="Guest"?"?":D.name[0].toUpperCase();
  $("pNm").textContent=D.name;$("pLv").textContent="Level "+l;$("pXp").style.width=Math.round(p*100)+"%";
  $("pNI").value=D.name==="Guest"?"":D.name;
  $("s1").textContent=D.bs;$("s2").textContent=D.gp;$("s3").textContent=D.tp;$("s4").textContent=D.bc;
  $("s5").textContent=D.gp?Math.round(D.ts/D.gp):0;$("s6").textContent=D.xp;
  const ag=$("aG");ag.innerHTML="";
  ACHS.forEach(a=>{const u=D.ach.includes(a.id);ag.innerHTML+=`<div class="ar ${u?"":"lk"}"><div style="font-size:18px;flex-shrink:0">${a.i}</div><div style="flex:1"><div style="color:#fff;font-size:11px;font-weight:bold">${a.n}</div><div style="color:rgba(255,255,255,0.25);font-size:9px;margin-top:1px">${a.d}</div></div>${u?'<div style="color:#51CF66;font-size:14px">‚úì</div>':""}</div>`});
  const sim=[{n:"StackMaster",s:87},{n:"NeonDrop",s:64},{n:"BlockKing",s:52},{n:"TapQueen",s:45},{n:"SwiftStack",s:38}];
  const all=[...sim.map(p=>({name:p.n,score:p.s})),{name:D.name,score:D.bs,you:true}].sort((a,b)=>b.score-a.score);
  const ll=$("lL");ll.innerHTML="";
  all.forEach((p,i)=>{const r=i+1,rc=r===1?"color:#FFC53D":r===2?"color:#C0C0C0":r===3?"color:#CD7F32":"color:rgba(255,255,255,0.25)";
    ll.innerHTML+=`<div class="lr ${p.you?"you":""}"><div style="font-size:13px;font-weight:bold;width:22px;text-align:center;${rc}">${r}</div><div style="flex:1;color:${p.you?"#FF6B6B":"rgba(255,255,255,0.6)"};font-size:12px">${p.name}${p.you?" (You)":""}</div><div style="color:rgba(255,255,255,0.4);font-size:13px;font-weight:bold">${p.score}</div></div>`});
}
function updAv(){$("btnProf").textContent=D.name==="Guest"?"?":D.name[0].toUpperCase()}

// ‚ïê‚ïê‚ïê SHARE ‚ïê‚ïê‚ïê
function shareGame(){
  const url=window.location.href;
  const txt="üèóÔ∏è STACK ‚Äî An addictive block stacking game that transforms as you climb higher. Power-ups, phase shifts, and a global leaderboard.\n\nPlay now: "+url+"\n\nby bbmw0";
  if(navigator.share){navigator.share({title:"STACK ‚Äî by bbmw0",text:"üèóÔ∏è STACK ‚Äî An addictive stacking game. How high can you go?",url}).catch(()=>{})}
  else{navigator.clipboard.writeText(txt).then(()=>alert("Link copied to clipboard!")).catch(()=>{})}
}
function shareScore(){
  const sc=S?S.sc:0,ph=S?getPhase(S.sc).name:"";
  const url=window.location.href;
  const txt="üèóÔ∏è STACK ‚Äî I scored "+sc+"! Reached "+ph+"\nBest: "+D.bs+" | Level "+getLv(D.xp)+"\n\nPlay: "+url+"\nby bbmw0";
  if(navigator.share){navigator.share({title:"STACK Score: "+sc,text:txt,url}).catch(()=>{})}
  else{navigator.clipboard.writeText(txt).then(()=>alert("Copied!")).catch(()=>{})}
}

// ‚ïê‚ïê‚ïê DRAW ‚ïê‚ïê‚ïê
function rrect(c,x,y,w,h,r){c.beginPath();c.moveTo(x+r,y);c.lineTo(x+w-r,y);c.quadraticCurveTo(x+w,y,x+w,y+r);c.lineTo(x+w,y+h-r);c.quadraticCurveTo(x+w,y+h,x+w-r,y+h);c.lineTo(x+r,y+h);c.quadraticCurveTo(x,y+h,x,y+h-r);c.lineTo(x,y+r);c.quadraticCurveTo(x,y,x+r,y);c.closePath()}

function loop(){
  if(!S){animId=null;return}
  const s=S;tick++;

  // Update
  if(!s.over&&s.mov){
    let spd=s.mov.speed;
    if(s.pu==="slow")spd*=0.4;
    s.mov.x+=s.mov.dir*spd;
    if(s.mov.x+s.mov.w>W+30)s.mov.dir=-1;
    if(s.mov.x<-30)s.mov.dir=1;
  }
  const tc=Math.max(0,(s.stack.length-Math.floor(H/BH*0.55))*BH);s.cam+=(tc-s.cam)*0.065;
  s.fall=s.fall.filter(f=>{f.vy+=GR;f.y+=f.vy;f.rot+=(f.vr||0);return f.y<H+200});
  s.parts=s.parts.filter(p=>{p.x+=p.vx;p.y+=p.vy;p.vy+=0.12;p.life-=0.02;return p.life>0});
  s.fire=s.fire.filter(f=>{f.x+=f.vx;f.y+=f.vy;f.life-=0.025;return f.life>0});
  s.trails=s.trails.filter(t=>{t.life-=0.015;return t.life>0});
  if(s.flash>0)s.flash--;
  if(s.shk>0)s.shk*=0.82;
  stars.forEach(st=>{st.b+=st.sp;if(st.b>1)st.b=0});

  const ph=getPhase(s.sc);

  // ‚îÄ‚îÄ Draw ‚îÄ‚îÄ
  ctx.save();
  if(s.shk>0.5)ctx.translate((Math.random()-0.5)*s.shk,(Math.random()-0.5)*s.shk*0.5);

  ctx.clearRect(-10,-10,W+20,H+20);
  const bg=ctx.createLinearGradient(0,0,0,H);bg.addColorStop(0,ph.bg1);bg.addColorStop(1,ph.bg2);ctx.fillStyle=bg;ctx.fillRect(0,0,W,H);

  // Stars
  for(const st of stars){
    const a=0.25+Math.sin(st.b*Math.PI*2)*0.35;
    ctx.fillStyle=`rgba(255,255,255,${a})`;ctx.beginPath();ctx.arc(st.x,st.y,st.s,0,Math.PI*2);ctx.fill();
  }

  // Grid
  const ga=Math.max(0.008,0.022-s.sc*0.0003);
  ctx.strokeStyle=`rgba(255,255,255,${ga})`;ctx.lineWidth=1;
  for(let gx=0;gx<W;gx+=30){ctx.beginPath();ctx.moveTo(gx,0);ctx.lineTo(gx,H);ctx.stroke()}

  const bY=H-50;

  // Neon trails
  for(const t of s.trails){
    ctx.save();ctx.globalAlpha=t.life*0.3;ctx.fillStyle=t.color;ctx.shadowColor=t.color;ctx.shadowBlur=20;
    ctx.fillRect(t.x,t.y,t.w,BH-2);ctx.restore();
  }

  // Stack
  for(let i=0;i<s.stack.length;i++){
    const b=s.stack[i],y=bY-i*BH+s.cam;if(y>H+BH||y<-BH*2)continue;
    ctx.fillStyle=b.color;ctx.shadowColor=b.color;ctx.shadowBlur=ph.glow;
    rrect(ctx,b.x,y,b.w,BH-2,3);ctx.fill();ctx.shadowBlur=0;
    ctx.fillStyle="rgba(255,255,255,0.1)";ctx.fillRect(b.x,y,b.w,BH*0.28);
    // Danger glow
    if(i===s.stack.length-1&&b.w<BW*0.28&&!s.over){
      ctx.shadowColor="#FF0000";ctx.shadowBlur=20+Math.sin(tick*0.15)*8;ctx.strokeStyle="rgba(255,50,50,0.25)";ctx.lineWidth=2;
      rrect(ctx,b.x,y,b.w,BH-2,3);ctx.stroke();ctx.shadowBlur=0;
    }
  }

  // Shield indicator on top block
  if(s.shield&&s.stack.length>0){
    const top=s.stack[s.stack.length-1],ty=bY-(s.stack.length-1)*BH+s.cam;
    ctx.save();ctx.strokeStyle="rgba(255,197,61,"+(.3+Math.sin(tick*0.08)*0.15)+")";ctx.lineWidth=2;ctx.setLineDash([4,4]);
    rrect(ctx,top.x-3,ty-3,top.w+6,BH+4,5);ctx.stroke();ctx.setLineDash([]);ctx.restore();
  }

  // Moving block
  if(!s.over&&s.mov){
    const my=bY-s.stack.length*BH+s.cam,m=s.mov;
    ctx.fillStyle=m.color;
    if(s.pu==="slow"){ctx.shadowColor="#339AF0";ctx.shadowBlur=22}
    else if(s.pu==="magnet"){ctx.shadowColor="#E599F7";ctx.shadowBlur=22}
    else{ctx.shadowColor=m.color;ctx.shadowBlur=ph.glow+4}
    rrect(ctx,m.x,my,m.w,BH-2,3);ctx.fill();ctx.shadowBlur=0;
    ctx.fillStyle="rgba(255,255,255,0.15)";ctx.fillRect(m.x,my,m.w,BH*0.28);
    // Guides
    const top=s.stack[s.stack.length-1];ctx.setLineDash([3,4]);ctx.strokeStyle="rgba(255,255,255,0.06)";ctx.lineWidth=1;
    ctx.beginPath();ctx.moveTo(top.x,my-12);ctx.lineTo(top.x,my+BH+8);ctx.stroke();
    ctx.beginPath();ctx.moveTo(top.x+top.w,my-12);ctx.lineTo(top.x+top.w,my+BH+8);ctx.stroke();ctx.setLineDash([]);
  }

  // Falling
  for(const f of s.fall){const fy=bY-s.stack.length*BH+s.cam+f.y;ctx.save();ctx.globalAlpha=Math.max(0,1-f.y/350);ctx.translate(f.x+f.w/2,fy+BH/2);ctx.rotate(f.rot||0);ctx.fillStyle=f.color;ctx.fillRect(-f.w/2,-BH/2+1,f.w,BH-2);ctx.restore()}

  // Particles
  for(const p of s.parts){ctx.save();ctx.globalAlpha=p.life;ctx.fillStyle=p.color;ctx.shadowColor=p.color;ctx.shadowBlur=4;ctx.beginPath();ctx.arc(p.x,p.y,p.sz*p.life,0,Math.PI*2);ctx.fill();ctx.restore()}

  // Fire
  for(const f of s.fire){
    ctx.save();ctx.globalAlpha=f.life*0.65;
    const gr=ctx.createRadialGradient(f.x,f.y,0,f.x,f.y,f.sz*f.life);
    gr.addColorStop(0,"#FFC53D");gr.addColorStop(0.6,"#FF6B6B");gr.addColorStop(1,"transparent");
    ctx.fillStyle=gr;ctx.beginPath();ctx.arc(f.x,f.y,f.sz*f.life,0,Math.PI*2);ctx.fill();ctx.restore();
  }

  // Flash
  if(s.flash>0){ctx.save();ctx.globalAlpha=(s.flash/22)*0.1;ctx.fillStyle="#fff";ctx.fillRect(0,0,W,H);ctx.restore()}

  ctx.restore();
  animId=requestAnimationFrame(loop);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EVENT HANDLING ‚Äî BULLETPROOF
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// TAP LAYER ‚Äî catches game taps during play
$("tapLayer").addEventListener("touchstart",function(e){e.preventDefault();gameTap()},{passive:false});
$("tapLayer").addEventListener("mousedown",function(e){e.preventDefault();gameTap()});
$("tapLayer").style.display="none"; // hidden until game starts

// START SCREEN ‚Äî tap anywhere to start (except buttons)
$("ovStart").addEventListener("touchstart",function(e){
  if(e.target.tagName==="BUTTON"||e.target.closest("button"))return;
  e.preventDefault();startGame();
},{passive:false});
$("ovStart").addEventListener("mousedown",function(e){
  if(e.target.tagName==="BUTTON"||e.target.closest("button"))return;
  e.preventDefault();startGame();
});
$("startCircle").addEventListener("touchstart",function(e){e.preventDefault();e.stopPropagation();startGame()},{passive:false});
$("startCircle").addEventListener("click",function(e){e.stopPropagation();startGame()});

// SPACE BAR
document.addEventListener("keydown",function(e){
  if(e.code!=="Space")return;e.preventDefault();
  if(!$("ovStart").classList.contains("hide"))startGame();
  else if(running&&S&&!S.over)gameTap();
});

// BUTTONS
$("btnRetry").addEventListener("click",function(e){e.stopPropagation();startGame()});
$("btnRetry").addEventListener("touchstart",function(e){e.preventDefault();e.stopPropagation();startGame()},{passive:false});
$("btnHome").addEventListener("click",function(e){e.stopPropagation();goHome()});
$("btnHome").addEventListener("touchstart",function(e){e.preventDefault();e.stopPropagation();goHome()},{passive:false});
$("btnShareScore").addEventListener("click",function(e){e.stopPropagation();shareScore()});
$("btnShareLink").addEventListener("click",function(e){e.stopPropagation();shareGame()});
$("btnShareLink").addEventListener("touchstart",function(e){e.preventDefault();e.stopPropagation();shareGame()},{passive:false});
$("btnNavProf").addEventListener("click",function(e){e.stopPropagation();openProf()});
$("btnNavProf").addEventListener("touchstart",function(e){e.preventDefault();e.stopPropagation();openProf()},{passive:false});
$("btnNavRank").addEventListener("click",function(e){e.stopPropagation();openProf()});
$("btnNavRank").addEventListener("touchstart",function(e){e.preventDefault();e.stopPropagation();openProf()},{passive:false});
$("btnProf").addEventListener("click",function(e){e.stopPropagation();openProf()});
$("btnProfX").addEventListener("click",function(e){e.stopPropagation();closeProf()});
$("btnProfX").addEventListener("touchstart",function(e){e.preventDefault();e.stopPropagation();closeProf()},{passive:false});
$("btnNSave").addEventListener("click",function(e){e.stopPropagation();const v=$("pNI").value.trim();if(v){D.name=v;sv(D);rProf();updAv()}});
["bG","bA","bL"].forEach(function(id){$(id).addEventListener("click",function(e){e.stopPropagation();
  if(typeof window._authGo==="function")window._authGo(id);
  else alert("Sign-in requires a backend server.\nSee SETUP.md for instructions.")})});
$("btnRst").addEventListener("click",function(e){e.stopPropagation();if(confirm("Reset all data?")){D={...DEF};sv(D);rProf();updAv()}});

// Prevent zoom
document.addEventListener("dblclick",function(e){e.preventDefault()});

// Init
updAv();$("dBs").textContent=D.bs;
})();
</script>
</body>
</html>
