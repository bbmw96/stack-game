<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>STACK ‚Äî by bbmw0</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="STACK">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0A0A1A">
<meta name="description" content="STACK ‚Äî the addictive block stacking game that transforms as you climb. Power-ups, 10 unique phases, and a global leaderboard. How high can you go?">
<meta property="og:title" content="STACK ‚Äî by bbmw0">
<meta property="og:description" content="An addictive stacking game that transforms as you climb. 10 phases, power-ups, and a global leaderboard. Can you reach the Cosmos?">
<meta property="og:type" content="website">
<link rel="manifest" href="/manifest.json">
<link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxODAiIGhlaWdodD0iMTgwIj48cmVjdCB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgcng9IjQwIiBmaWxsPSIjMEEwQTFBIi8+PHJlY3QgeD0iMzAiIHk9IjExNSIgd2lkdGg9IjEyMCIgaGVpZ2h0PSIyNCIgcng9IjQiIGZpbGw9IiNGRjZCNkIiLz48cmVjdCB4PSIzOCIgeT0iODkiIHdpZHRoPSIxMDQiIGhlaWdodD0iMjQiIHJ4PSI0IiBmaWxsPSIjRkY4RTUzIi8+PHJlY3QgeD0iNDYiIHk9IjYzIiB3aWR0aD0iODgiIGhlaWdodD0iMjQiIHJ4PSI0IiBmaWxsPSIjRkZDNTNEIi8+PHJlY3QgeD0iNTQiIHk9IjM3IiB3aWR0aD0iNzIiIGhlaWdodD0iMjQiIHJ4PSI0IiBmaWxsPSIjNTFDRjY2Ii8+PC9zdmc+">
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;background:#0A0A1A;font-family:'Courier New',Courier,monospace;-webkit-user-select:none;user-select:none;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none}
#app{width:100%;height:100dvh;position:relative;overflow:hidden;touch-action:manipulation}
canvas{display:block;width:100%;height:100%;position:absolute;top:0;left:0}
#tapLayer{position:absolute;inset:0;z-index:5;display:none}
.nt{pointer-events:none}

.hud{position:absolute;top:env(safe-area-inset-top,16px);left:0;right:0;padding:14px 20px;display:flex;justify-content:space-between;align-items:flex-start;z-index:12;pointer-events:none}
.hsc{color:#fff;font-size:42px;font-weight:bold;line-height:1;text-shadow:0 0 20px rgba(255,107,107,0.4)}
.hbs{color:rgba(255,255,255,0.4);font-size:18px;font-weight:bold}
.hl{color:rgba(255,255,255,0.28);font-size:9px;letter-spacing:3px;text-transform:uppercase}
.hpb{pointer-events:all;cursor:pointer;width:34px;height:34px;border-radius:50%;background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.1);display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,0.4);font-size:13px;font-weight:bold;margin-top:4px}

.plbl{position:absolute;top:env(safe-area-inset-top,16px);left:50%;transform:translateX(-50%);z-index:12;pointer-events:none;font-size:9px;letter-spacing:4px;text-transform:uppercase;opacity:0.45;transition:all 0.5s}
.pup{position:absolute;bottom:75px;left:50%;transform:translateX(-50%);z-index:12;pointer-events:none;padding:6px 16px;border-radius:18px;font-size:11px;font-weight:bold;letter-spacing:2px;opacity:0;transition:opacity 0.3s}
.pup.on{opacity:1}
.clbl{position:absolute;top:90px;left:50%;transform:translateX(-50%);z-index:12;pointer-events:none;font-size:15px;font-weight:bold;opacity:0;transition:opacity 0.2s;text-shadow:0 0 12px currentColor}
.clbl.on{opacity:1}
.ftxt{position:absolute;top:36%;left:50%;transform:translate(-50%,-50%);z-index:12;pointer-events:none;color:#fff;font-size:24px;font-weight:bold;letter-spacing:8px;text-shadow:0 0 25px rgba(255,255,255,0.5);opacity:0;transition:opacity 0.12s}
.ftxt.on{opacity:0.9}
.pann{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%) scale(0.5);z-index:14;pointer-events:none;text-align:center;opacity:0;transition:all 0.5s cubic-bezier(0.175,0.885,0.32,1.275)}
.pann.on{opacity:1;transform:translate(-50%,-50%) scale(1)}
.pann-n{font-size:34px;font-weight:bold;color:#fff;letter-spacing:5px}
.pann-s{font-size:10px;letter-spacing:3px;margin-top:5px;opacity:0.35}
.ach{position:absolute;top:55px;left:50%;transform:translateX(-50%) translateY(-70px);z-index:30;background:rgba(25,25,45,0.95);border:1px solid rgba(255,197,61,0.25);border-radius:10px;padding:9px 15px;display:flex;align-items:center;gap:8px;opacity:0;transition:all 0.4s;pointer-events:none}
.ach.on{transform:translateX(-50%) translateY(0);opacity:1}

/* OVERLAYS */
.ov{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:20;background:rgba(10,10,26,0.95);backdrop-filter:blur(14px);-webkit-backdrop-filter:blur(14px);transition:opacity 0.3s}
.ov.hide{opacity:0;pointer-events:none}

/* Start */
.st{font-size:56px;font-weight:bold;color:#fff;letter-spacing:10px;text-shadow:0 0 50px rgba(255,107,107,0.4),0 0 100px rgba(255,107,107,0.15);margin-bottom:4px}
.ss{color:rgba(255,255,255,0.22);font-size:11px;letter-spacing:6px;margin-bottom:5px}
.sv{color:rgba(255,255,255,0.1);font-size:9px;letter-spacing:2px;margin-bottom:32px}
.sc{width:68px;height:68px;border-radius:50%;border:2px solid rgba(255,255,255,0.1);display:flex;align-items:center;justify-content:center;animation:br 2s infinite ease-in-out;cursor:pointer}
.sd{width:14px;height:14px;border-radius:50%;background:#FF6B6B;box-shadow:0 0 18px rgba(255,107,107,0.4)}
.slbl{color:rgba(255,255,255,0.16);font-size:10px;letter-spacing:3px;margin-top:16px}
.sby{color:rgba(255,255,255,0.13);font-size:10px;letter-spacing:2px;margin-top:24px}
.snav{position:absolute;bottom:env(safe-area-inset-bottom,28px);display:flex;gap:10px;flex-wrap:wrap;justify-content:center;padding:0 16px 8px}
.sbtn{color:rgba(255,255,255,0.25);font-size:9px;letter-spacing:2px;cursor:pointer;padding:8px 14px;border:1px solid rgba(255,255,255,0.06);border-radius:20px;font-family:inherit;background:none}
.sbtn:active{background:rgba(255,255,255,0.04)}
.shr-btn{padding:8px 14px;border:1px solid rgba(255,107,107,0.15);border-radius:20px;background:rgba(255,107,107,0.05);color:rgba(255,107,107,0.55);font-size:9px;letter-spacing:2px;cursor:pointer;font-family:inherit}
.cof-btn{padding:8px 14px;border:1px solid rgba(255,197,61,0.15);border-radius:20px;background:rgba(255,197,61,0.05);color:rgba(255,197,61,0.55);font-size:9px;letter-spacing:2px;cursor:pointer;font-family:inherit}

/* Game Over */
.gl{color:rgba(255,255,255,0.28);font-size:11px;letter-spacing:5px;text-transform:uppercase;margin-bottom:8px}
.gsc{font-size:72px;font-weight:bold;color:#fff;line-height:1;text-shadow:0 0 25px rgba(255,107,107,0.35)}
.gnw{color:#FFC53D;font-size:12px;letter-spacing:3px;margin-top:5px}.gnw.hide{display:none}
.gbs{color:rgba(255,255,255,0.22);font-size:12px;margin-top:5px}
.gph{color:rgba(255,255,255,0.16);font-size:9px;letter-spacing:2px;margin:5px 0}
.gr{display:flex;gap:28px;margin:10px 0}
.gsl{color:rgba(255,255,255,0.22);font-size:9px;letter-spacing:2px;text-transform:uppercase;text-align:center}
.gsv{color:rgba(255,255,255,0.6);font-size:18px;font-weight:bold;text-align:center;margin-top:2px}
.gxp{color:rgba(255,255,255,0.18);font-size:10px;margin-bottom:14px}.gxp span{color:#51CF66}
.gbtn{display:flex;gap:10px}
.gb{padding:12px 26px;border:1px solid rgba(255,255,255,0.08);border-radius:24px;color:rgba(255,255,255,0.4);font-size:10px;letter-spacing:3px;text-transform:uppercase;font-family:inherit;cursor:pointer;background:none}
.gb:active{background:rgba(255,255,255,0.04)}
.gb.pr{border-color:rgba(255,107,107,0.2);color:rgba(255,107,107,0.7)}
.gshare{margin-top:8px;padding:8px 20px;border:1px solid rgba(255,255,255,0.04);border-radius:18px;color:rgba(255,255,255,0.18);font-size:9px;letter-spacing:2px;cursor:pointer;background:none;font-family:inherit}

/* GUIDE SCREEN */
.guide{overflow-y:auto;padding:50px 20px 40px;align-items:stretch;justify-content:flex-start;-webkit-overflow-scrolling:touch}
.gd-title{color:#fff;font-size:22px;font-weight:bold;letter-spacing:4px;text-align:center;margin-bottom:6px}
.gd-sub{color:rgba(255,255,255,0.2);font-size:10px;letter-spacing:3px;text-align:center;margin-bottom:24px}
.gd-card{background:rgba(255,255,255,0.025);border:1px solid rgba(255,255,255,0.04);border-radius:12px;padding:14px 16px;margin-bottom:10px;display:flex;gap:12px;align-items:flex-start}
.gd-num{font-size:22px;font-weight:bold;line-height:1;min-width:30px}
.gd-info{flex:1}
.gd-name{color:#fff;font-size:13px;font-weight:bold;letter-spacing:1px}
.gd-range{color:rgba(255,255,255,0.2);font-size:9px;letter-spacing:1px;margin-top:2px}
.gd-desc{color:rgba(255,255,255,0.35);font-size:10px;line-height:1.5;margin-top:6px}
.gd-mechanic{display:inline-block;padding:3px 8px;border-radius:10px;font-size:8px;font-weight:bold;letter-spacing:1px;margin-top:4px}
.gd-sec{color:rgba(255,255,255,0.2);font-size:9px;letter-spacing:3px;text-transform:uppercase;margin:20px 0 10px;text-align:center}
.gd-pu{display:flex;align-items:center;gap:10px;padding:10px 14px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.04);border-radius:10px;margin-bottom:8px}
.gd-pu-icon{font-size:20px}
.gd-pu-name{color:#fff;font-size:11px;font-weight:bold}
.gd-pu-desc{color:rgba(255,255,255,0.3);font-size:9px;margin-top:1px}
.cls-btn{position:absolute;top:env(safe-area-inset-top,14px);right:14px;width:36px;height:36px;border-radius:50%;background:rgba(255,255,255,0.05);border:none;color:rgba(255,255,255,0.3);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-family:inherit;z-index:2}

/* Profile */
.prof{overflow-y:auto;padding:50px 20px 40px;align-items:stretch;justify-content:flex-start;-webkit-overflow-scrolling:touch}
.phdr{text-align:center;margin-bottom:24px}
.pav{width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,#FF6B6B,#845EF7);display:flex;align-items:center;justify-content:center;margin:0 auto 8px;font-size:24px;font-weight:bold;color:#fff}
.pnm{color:#fff;font-size:16px;font-weight:bold;letter-spacing:2px}
.plv{color:rgba(255,255,255,0.28);font-size:10px;letter-spacing:2px;margin-top:3px}
.xpb{width:160px;height:3px;background:rgba(255,255,255,0.06);border-radius:2px;margin:6px auto 0;overflow:hidden}
.xpf{height:100%;background:linear-gradient(90deg,#51CF66,#339AF0);border-radius:2px;transition:width 0.4s}
.sec{color:rgba(255,255,255,0.22);font-size:9px;letter-spacing:3px;text-transform:uppercase;margin:20px 0 8px}
.sg{display:grid;grid-template-columns:1fr 1fr;gap:7px}
.scd{background:rgba(255,255,255,0.025);border:1px solid rgba(255,255,255,0.04);border-radius:9px;padding:11px;text-align:center}
.scv{color:#fff;font-size:20px;font-weight:bold}
.scl{color:rgba(255,255,255,0.22);font-size:8px;letter-spacing:2px;text-transform:uppercase;margin-top:2px}
.ag{display:flex;flex-direction:column;gap:5px}
.ar{display:flex;align-items:center;gap:9px;padding:9px 11px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);border-radius:8px}
.ar.lk{opacity:0.25}
.ll{display:flex;flex-direction:column;gap:4px}
.lr{display:flex;align-items:center;gap:9px;padding:8px 11px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);border-radius:8px}
.lr.you{border-color:rgba(255,107,107,0.12);background:rgba(255,107,107,0.03)}
.gs{display:flex;gap:7px;margin-bottom:12px}
.gi{flex:1;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.07);border-radius:8px;padding:8px 11px;color:#fff;font-family:inherit;font-size:12px;outline:none}
.gi::placeholder{color:rgba(255,255,255,0.15)}
.gsb{background:rgba(255,107,107,0.1);border:1px solid rgba(255,107,107,0.15);border-radius:8px;padding:8px 12px;color:#FF6B6B;font-family:inherit;font-size:11px;font-weight:bold;cursor:pointer}
.lb{display:flex;flex-direction:column;gap:7px}
.lbn{display:flex;align-items:center;justify-content:center;gap:7px;padding:11px 16px;border-radius:10px;border:1px solid rgba(255,255,255,0.07);font-family:inherit;font-size:11px;font-weight:bold;cursor:pointer}
.lbn.gg{background:rgba(255,255,255,0.92);color:#333}
.lbn.ap{background:#000;color:#fff;border-color:rgba(255,255,255,0.12)}
.lbn.li{background:#0A66C2;color:#fff;border-color:transparent}
.lbn svg{flex-shrink:0}
.rst{margin-top:16px;padding:8px 16px;border:1px solid rgba(255,60,60,0.1);border-radius:8px;background:none;color:rgba(255,60,60,0.3);font-size:8px;letter-spacing:2px;cursor:pointer;font-family:inherit;text-transform:uppercase;align-self:center}

@keyframes br{0%,100%{transform:scale(1);opacity:0.5}50%{transform:scale(1.1);opacity:1}}
</style>
</head>
<body>
<div id="app">
<canvas id="c"></canvas>
<div id="tapLayer"></div>

<div class="hud nt" id="hud" style="display:none">
  <div><div class="hl">Score</div><div class="hsc" id="dSc">0</div></div>
  <div style="display:flex;flex-direction:column;align-items:flex-end;gap:5px">
    <div><div class="hl" style="text-align:right">Best</div><div class="hbs" id="dBs">0</div></div>
    <div class="hpb" id="bPr" style="pointer-events:all">?</div>
  </div>
</div>
<div class="plbl nt" id="dPh"></div>
<div class="pup nt" id="dPu"></div>
<div class="clbl nt" id="dCo"></div>
<div class="ftxt nt" id="dFl">PERFECT</div>
<div class="pann nt" id="dPA"><div class="pann-n" id="dPAN"></div><div class="pann-s" id="dPAS"></div></div>
<div class="ach nt" id="dAc"><div id="dAcI" style="font-size:18px">üèÜ</div><div><div style="color:rgba(255,197,61,0.45);font-size:8px;letter-spacing:2px">ACHIEVEMENT</div><div id="dAcN" style="color:#fff;font-size:11px;font-weight:bold;margin-top:1px">‚Äî</div></div></div>

<!-- START -->
<div class="ov" id="ovS">
  <div class="st">STACK</div>
  <div class="ss">TAP TO DROP</div>
  <div class="sv">v3.0 ‚Äî 10 phases</div>
  <div class="sc" id="startC"><div class="sd"></div></div>
  <div class="slbl">TAP ANYWHERE</div>
  <div class="sby">created by bbmw0</div>
  <div class="snav">
    <button class="sbtn" id="bNP">PROFILE</button>
    <button class="sbtn" id="bNG">GUIDE</button>
    <button class="shr-btn" id="bSL">‚Üó SHARE</button>
    <button class="cof-btn" id="bCof">‚òï SUPPORT</button>
  </div>
</div>

<!-- GAME OVER -->
<div class="ov hide" id="ovG">
  <div class="gl">Game Over</div>
  <div class="gsc" id="gSc">0</div>
  <div class="gnw hide" id="gNw">‚òÖ NEW BEST ‚òÖ</div>
  <div class="gbs" id="gBs">Best: 0</div>
  <div class="gph" id="gPh"></div>
  <div class="gr">
    <div><div class="gsl">Combo</div><div class="gsv" id="gCo">0</div></div>
    <div><div class="gsl">Perfects</div><div class="gsv" id="gPf">0</div></div>
    <div><div class="gsl">Games</div><div class="gsv" id="gGp">0</div></div>
  </div>
  <div class="gxp" id="gXp">+<span>0</span> XP</div>
  <div class="gbtn">
    <button class="gb pr" id="bRe">RETRY</button>
    <button class="gb" id="bHo">HOME</button>
  </div>
  <button class="gshare" id="bSS">SHARE SCORE</button>
</div>

<!-- GUIDE -->
<div class="ov hide guide" id="ovGd">
  <button class="cls-btn" id="bGdX">‚úï</button>
  <div class="gd-title">PHASE GUIDE</div>
  <div class="gd-sub">THE GAME TRANSFORMS AS YOU CLIMB</div>
  <div id="gdList"></div>
  <div class="gd-sec">POWER-UPS</div>
  <div id="gdPU"></div>
  <div class="gd-sec">TIPS</div>
  <div style="color:rgba(255,255,255,0.3);font-size:10px;line-height:1.7;text-align:center;padding:0 10px">
    Perfect drops grow your block back.<br>
    High combos create fire trails.<br>
    üõ°Ô∏è Shield saves you from one miss.<br>
    Thin blocks glow red ‚Äî danger zone.<br>
    Every 10 stacks triggers a milestone.<br>
    The game never ends ‚Äî how far can you go?
  </div>
</div>

<!-- PROFILE -->
<div class="ov hide prof" id="ovPr">
  <button class="cls-btn" id="bPrX">‚úï</button>
  <div class="phdr"><div class="pav" id="pAv">?</div><div class="pnm" id="pNm">Guest</div><div class="plv" id="pLv">Level 1</div><div class="xpb"><div class="xpf" id="pXp" style="width:0%"></div></div></div>
  <div class="sec">Player Name</div>
  <div class="gs"><input type="text" class="gi" id="pNI" placeholder="Enter name..." maxlength="16"><button class="gsb" id="bNS">SAVE</button></div>
  <div class="sec">Statistics</div>
  <div class="sg"><div class="scd"><div class="scv" id="s1">0</div><div class="scl">Best</div></div><div class="scd"><div class="scv" id="s2">0</div><div class="scl">Games</div></div><div class="scd"><div class="scv" id="s3">0</div><div class="scl">Perfects</div></div><div class="scd"><div class="scv" id="s4">0</div><div class="scl">Combo</div></div><div class="scd"><div class="scv" id="s5">0</div><div class="scl">Avg</div></div><div class="scd"><div class="scv" id="s6">0</div><div class="scl">XP</div></div></div>
  <div class="sec">Achievements</div>
  <div class="ag" id="aG"></div>
  <div class="sec">Leaderboard</div>
  <div class="ll" id="lL"></div>
  <div class="sec">Sign In</div>
  <div style="color:rgba(255,255,255,0.18);font-size:9px;text-align:center;margin-bottom:10px">Save progress across devices</div>
  <div class="lb">
    <button class="lbn gg" id="bG"><svg width="15" height="15" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>Google</button>
    <button class="lbn ap" id="bA"><svg width="15" height="15" viewBox="0 0 24 24" fill="white"><path d="M17.05 20.28c-.98.95-2.05.88-3.08.4-1.09-.5-2.08-.48-3.24 0-1.44.62-2.2.44-3.06-.4C2.79 15.25 3.51 7.59 9.05 7.31c1.35.07 2.29.74 3.08.8 1.18-.24 2.31-.93 3.57-.84 1.51.12 2.65.72 3.4 1.8-3.12 1.87-2.38 5.98.48 7.13-.57 1.5-1.31 2.99-2.54 4.09zM12.03 7.25c-.15-2.23 1.66-4.07 3.74-4.25.29 2.58-2.34 4.5-3.74 4.25z"/></svg>Apple</button>
    <button class="lbn li" id="bL"><svg width="15" height="15" viewBox="0 0 24 24" fill="white"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>LinkedIn</button>
  </div>
  <div style="color:rgba(255,255,255,0.1);font-size:8px;text-align:center;margin-top:7px;letter-spacing:1px">Backend required for sign-in</div>
  <button class="rst" id="bRst">RESET ALL DATA</button>
</div>
</div>

<script>
(function(){
"use strict";
const $=id=>document.getElementById(id);

const BH=28,BW=110,SI=2.0,SINC=0.09,SMAX=12,PT=5,GR=0.55;

// ‚ïê‚ïê‚ïê 10 PHASES ‚ïê‚ïê‚ïê
const PH=[
  {id:"classic",n:"CLASSIC",s:"Learn the basics",from:0,to:7,bg1:"#0A0A1A",bg2:"#151528",c:["#FF6B6B","#FF8E53","#FFC53D","#51CF66","#339AF0","#845EF7"],st:0,sm:1,gl:8,mc:"Normal speed, full-width blocks"},
  {id:"neon",n:"NEON RUSH",s:"Blocks leave glowing trails",from:8,to:14,bg1:"#0D0025",bg2:"#1A003A",c:["#00F5FF","#00FF87","#FF00E5","#FFE500","#FF6B6B","#7B61FF"],st:10,sm:1.08,gl:18,trail:true,mc:"Neon trails + slightly faster"},
  {id:"pulse",n:"PULSE",s:"Speed pulses up and down",from:15,to:21,bg1:"#1A0505",bg2:"#2D0A0A",c:["#FF6B6B","#FF8787","#FFA8A8","#FFC9C9","#FFE3E3","#FFF5F5"],st:15,sm:1,gl:12,pulse:true,mc:"Speed oscillates rhythmically"},
  {id:"narrow",n:"THE SQUEEZE",s:"Blocks start shrinking",from:22,to:29,bg1:"#0A1A0A",bg2:"#0A2D0A",c:["#51CF66","#69DB7C","#8CE99A","#B2F2BB","#D3F9D8","#20C997"],st:22,sm:1.1,gl:10,shrink:0.92,mc:"Each block slightly narrower"},
  {id:"mirror",n:"MIRROR",s:"Direction flips mid-slide",from:30,to:37,bg1:"#1A1A00",bg2:"#2D2D00",c:["#FFC53D","#FFD43B","#FFE066","#FFEC99","#FFF3BF","#FF922B"],st:30,sm:1.15,gl:14,mirror:true,mc:"Block reverses direction randomly"},
  {id:"stealth",n:"STEALTH",s:"Guide lines disappear",from:38,to:45,bg1:"#0A0A1A",bg2:"#0F0F2A",c:["#5C7CFA","#748FFC","#91A7FF","#BAC8FF","#DBE4FF","#339AF0"],st:40,sm:1.12,gl:8,noGuide:true,mc:"No alignment guides ‚Äî trust your eyes"},
  {id:"hyper",n:"HYPERDRIVE",s:"Maximum velocity",from:46,to:55,bg1:"#0A000A",bg2:"#1A0020",c:["#FF6B6B","#F06595","#E599F7","#B197FC","#845EF7","#FFC53D"],st:55,sm:1.35,gl:20,mc:"Everything moves faster"},
  {id:"chaos",n:"CHAOS",s:"Random speed + shrink + mirrors",from:56,to:69,bg1:"#1A0A00",bg2:"#200A10",c:["#FF922B","#FD7E14","#F76707","#E8590C","#D9480F","#FFC53D"],st:70,sm:1.2,gl:16,chaos:true,mc:"All modifiers active randomly"},
  {id:"zen",n:"ZEN ZONE",s:"Calm before the cosmos",from:70,to:84,bg1:"#050510",bg2:"#0A0A20",c:["#C3FAE8","#96F2D7","#63E6BE","#38D9A9","#20C997","#12B886"],st:90,sm:0.95,gl:22,mc:"Slower but blocks are thin ‚Äî focus"},
  {id:"cosmos",n:"COSMOS",s:"Beyond everything",from:85,to:9999,bg1:"#000000",bg2:"#050005",c:["#FFFFFF","#FFC53D","#FF6B6B","#00F5FF","#51CF66","#E599F7"],st:130,sm:1.45,gl:28,mc:"The ultimate challenge"},
];
function gP(sc){return PH.find(p=>sc>=p.from&&sc<=p.to)||PH[0]}

const PUS=[
  {id:"wide",l:"‚¨õ WIDER",c:"#51CF66",bg:"rgba(81,207,102,0.1)",bd:"rgba(81,207,102,0.2)",d:"Next block is wider"},
  {id:"slow",l:"üê¢ SLOW-MO",c:"#339AF0",bg:"rgba(51,154,240,0.1)",bd:"rgba(51,154,240,0.2)",d:"Block moves at half speed"},
  {id:"magnet",l:"üß≤ MAGNET",c:"#E599F7",bg:"rgba(229,153,247,0.1)",bd:"rgba(229,153,247,0.2)",d:"Auto-snaps if close enough"},
  {id:"shield",l:"üõ°Ô∏è SHIELD",c:"#FFC53D",bg:"rgba(255,197,61,0.1)",bd:"rgba(255,197,61,0.2)",d:"Saves you from one miss"},
  {id:"freeze",l:"‚ùÑÔ∏è FREEZE",c:"#22B8CF",bg:"rgba(34,184,207,0.1)",bd:"rgba(34,184,207,0.2)",d:"Block stops for 1 second"},
];

const ACHS=[
  {id:"f",i:"üéØ",n:"First Stack",d:"Complete a game",ck:d=>d.gp>=1},
  {id:"10",i:"üîü",n:"Double Digits",d:"Score 10",ck:d=>d.bs>=10},
  {id:"25",i:"üåü",n:"Quarter Century",d:"Score 25",ck:d=>d.bs>=25},
  {id:"50",i:"üî•",n:"Fifty Stack",d:"Score 50",ck:d=>d.bs>=50},
  {id:"85",i:"üíé",n:"Cosmic Entry",d:"Score 85",ck:d=>d.bs>=85},
  {id:"100",i:"üëë",n:"Centurion",d:"Score 100",ck:d=>d.bs>=100},
  {id:"c3",i:"‚ö°",n:"Triple Threat",d:"3√ó combo",ck:d=>d.bc>=3},
  {id:"c5",i:"üåä",n:"On Fire",d:"5√ó combo",ck:d=>d.bc>=5},
  {id:"c10",i:"‚òÑÔ∏è",n:"Unstoppable",d:"10√ó combo",ck:d=>d.bc>=10},
  {id:"g10",i:"üéÆ",n:"Regular",d:"10 games",ck:d=>d.gp>=10},
  {id:"g50",i:"üèÖ",n:"Dedicated",d:"50 games",ck:d=>d.gp>=50},
  {id:"g100",i:"üèÜ",n:"Obsessed",d:"100 games",ck:d=>d.gp>=100},
  {id:"neo",i:"üíú",n:"Neon Runner",d:"Reach Neon Rush",ck:d=>d.bs>=8},
  {id:"sq",i:"üíö",n:"Squeezed",d:"Reach The Squeeze",ck:d=>d.bs>=22},
  {id:"hyp",i:"üöÄ",n:"Hyperdrive",d:"Reach Hyperdrive",ck:d=>d.bs>=46},
  {id:"zen",i:"üßò",n:"Inner Peace",d:"Reach Zen Zone",ck:d=>d.bs>=70},
  {id:"cos",i:"üåå",n:"Cosmic",d:"Reach the Cosmos",ck:d=>d.bs>=85},
];

const DEF={name:"Guest",bs:0,gp:0,tp:0,bc:0,ts:0,xp:0,ach:[]};
function ld(){try{const r=localStorage.getItem("stk4");if(r)return{...DEF,...JSON.parse(r)}}catch(e){}return{...DEF}}
function sv(d){try{localStorage.setItem("stk4",JSON.stringify(d))}catch(e){}}
let D=ld();
function xpF(l){return l*l*50}
function gLv(x){let l=1;while(x>=xpF(l))l++;return l}
function gLvP(x){const l=gLv(x),p=xpF(l-1),n=xpF(l);return l===1?x/n:(x-p)/(n-p)}

const canvas=$("c"),ctx=canvas.getContext("2d");
let W,H,dpr;
function resize(){dpr=window.devicePixelRatio||1;W=window.innerWidth;H=window.innerHeight;canvas.width=W*dpr;canvas.height=H*dpr;ctx.setTransform(dpr,0,0,dpr,0,0)}
window.addEventListener("resize",resize);resize();

let ac=null;
function iA(){if(!ac)ac=new(window.AudioContext||window.webkitAudioContext)();if(ac.state==="suspended")ac.resume()}
function tn(f,d,v){if(!ac)return;const o=ac.createOscillator(),g=ac.createGain();o.type="sine";o.frequency.value=f;g.gain.setValueAtTime(v||0.08,ac.currentTime);g.gain.exponentialRampToValueAtTime(0.001,ac.currentTime+d);o.connect(g);g.connect(ac.destination);o.start();o.stop(ac.currentTime+d)}
function sP(co){tn(300+Math.min(co,12)*40,0.1,0.07);if(co>=2)tn(450+co*30,0.15,0.05)}
function sF(){tn(150,0.25,0.1);setTimeout(()=>tn(100,0.3,0.07),100)}
function sPh(){[523,659,784,1047].forEach((f,i)=>setTimeout(()=>tn(f,0.1,0.06),i*90))}
function sPu(){tn(800,0.07,0.05);setTimeout(()=>tn(1200,0.08,0.06),80)}
function vb(p){if(navigator.vibrate)navigator.vibrate(p)}

let stars=[];
function gSt(n){stars=[];for(let i=0;i<n;i++)stars.push({x:Math.random()*W,y:Math.random()*H,s:Math.random()*1.6+0.3,b:Math.random(),sp:Math.random()*0.004+0.001})}

let S=null,run=false,aId=null,cPh="",tk=0;

function mkS(){return{stack:[{x:(W-BW)/2,w:BW,color:PH[0].c[0]}],mov:null,fall:[],pts:[],fire:[],trails:[],cam:0,sc:0,co:0,mc:0,pf:0,over:false,fl:0,shk:0,pu:null,puT:0,puN:Math.floor(Math.random()*5)+5,shield:false,frozen:0,dualTk:0}}

function spn(s){
  const ph=gP(s.sc),top=s.stack[s.stack.length-1],ci=s.stack.length%ph.c.length;
  let spd=Math.min(SI+s.sc*SINC,SMAX)*ph.sm;
  if(ph.pulse)spd*=0.7+Math.sin(s.sc*0.3)*0.5;
  if(ph.chaos){spd*=0.8+Math.random()*0.6}
  const dir=s.sc%2===0?1:-1;
  let w=top.w;
  if(ph.shrink)w*=ph.shrink;
  if(ph.chaos&&Math.random()<0.3)w*=0.9+Math.random()*0.15;
  w=Math.max(w,top.w);
  if(s.pu==="wide")w=Math.min(w+26,BW*1.35);
  s.mov={x:dir===1?-w-20:W+20,w,dir,speed:spd,color:ph.c[ci],mirrorCd:ph.mirror?Math.floor(Math.random()*30)+15:0}
}

// ‚ïê‚ïê‚ïê GUIDE ‚ïê‚ïê‚ïê
function buildGuide(){
  let h="";
  PH.forEach((p,i)=>{h+=`<div class="gd-card"><div class="gd-num" style="color:${p.c[0]}">${i+1}</div><div class="gd-info"><div class="gd-name" style="color:${p.c[0]}">${p.n}</div><div class="gd-range">Stacks ${p.from}${p.to<9999?" ‚Äì "+p.to:"+"}</div><div class="gd-desc">${p.mc}</div><div class="gd-mechanic" style="background:${p.c[0]}22;color:${p.c[0]}">${p.s.toUpperCase()}</div></div></div>`});
  $("gdList").innerHTML=h;
  let pu="";
  PUS.forEach(p=>{pu+=`<div class="gd-pu"><div class="gd-pu-icon">${p.l.split(" ")[0]}</div><div><div class="gd-pu-name" style="color:${p.c}">${p.l}</div><div class="gd-pu-desc">${p.d}</div></div></div>`});
  $("gdPU").innerHTML=pu;
}
buildGuide();

// ‚ïê‚ïê‚ïê ACTIONS ‚ïê‚ïê‚ïê
function startG(){iA();S=mkS();spn(S);run=true;cPh="";tk=0;gSt(0);$("hud").style.display="flex";$("ovS").classList.add("hide");$("ovG").classList.add("hide");$("ovPr").classList.add("hide");$("ovGd").classList.add("hide");$("tapLayer").style.display="block";$("dSc").textContent="0";$("dBs").textContent=D.bs;$("dCo").classList.remove("on");$("dFl").classList.remove("on");$("dPh").textContent="";$("dPu").classList.remove("on");uAv();if(!aId)loop()}
function goH(){run=false;S=null;if(aId){cancelAnimationFrame(aId);aId=null}$("hud").style.display="none";$("ovG").classList.add("hide");$("ovS").classList.remove("hide");$("tapLayer").style.display="none";$("dPh").textContent="";$("dPu").classList.remove("on")}

function tap(){if(!S||S.over||!run)return;drop()}

function drop(){
  if(!S||S.over)return;const s=S;
  if(s.frozen>0)return;
  const top=s.stack[s.stack.length-1],m=s.mov;
  const oS=Math.max(top.x,m.x),oE=Math.min(top.x+top.w,m.x+m.w);let oW=oE-oS;
  if(s.pu==="magnet"&&oW>0&&Math.abs(m.x-top.x)<22){s.stack.push({x:top.x,w:top.w,color:m.color});s.co++;s.pf++;if(s.co>s.mc)s.mc=s.co;s.fl=20;mP(s,top);vb(10);sF2("PERFECT");aP(s,true);return}
  if(oW<=0&&s.shield){s.shield=false;$("dPu").classList.remove("on");s.stack.push({x:top.x,w:Math.max(top.w*0.55,18),color:m.color});s.co=0;s.sc++;sF2("SAVED!");$("dSc").textContent=s.sc;sPu();spn(s);return}
  if(oW<=0){s.over=true;s.fall.push({x:m.x,w:m.w,y:0,vy:0,rot:0,vr:(Math.random()-0.5)*0.08,color:m.color});sF();vb([50,30,50]);s.shk=10;eG(s);return}
  const perf=Math.abs(m.x-top.x)<PT&&Math.abs(m.w-top.w)<PT;
  if(perf){s.stack.push({x:top.x,w:top.w,color:m.color});s.co++;s.pf++;if(s.co>s.mc)s.mc=s.co;s.fl=20;mP(s,top);vb(10);sF2(s.co>=3?"üî• PERFECT":"PERFECT")}
  else{s.stack.push({x:oS,w:oW,color:m.color});s.co=0;if(m.x<top.x)s.fall.push({x:m.x,w:top.x-m.x,y:0,vy:0,rot:0,vr:-0.03,color:m.color});if(m.x+m.w>top.x+top.w)s.fall.push({x:top.x+top.w,w:(m.x+m.w)-(top.x+top.w),y:0,vy:0,rot:0,vr:0.03,color:m.color});vb(5)}
  aP(s,perf);
}

function aP(s,perf){
  s.sc++;$("dSc").textContent=s.sc;sP(s.co);
  if(s.co>=2){$("dCo").classList.add("on");$("dCo").style.color=gP(s.sc).c[0];$("dCo").textContent="üî• √ó"+s.co+" PERFECT"}else $("dCo").classList.remove("on");
  if(s.co>=3){const t=s.stack[s.stack.length-1];for(let i=0;i<8;i++)s.fire.push({x:t.x+Math.random()*t.w,y:H-50-(s.stack.length-1)*BH+s.cam,life:1,vx:(Math.random()-0.5)*2.5,vy:-Math.random()*3.5-1.5,sz:Math.random()*5+3})}
  const ph=gP(s.sc);
  if(ph.id!==cPh){cPh=ph.id;$("dPh").textContent=ph.n;$("dPh").style.color=ph.c[0];gSt(ph.st);shPA(ph);sPh()}
  if(ph.trail){const t=s.stack[s.stack.length-1];s.trails.push({x:t.x,w:t.w,y:H-50-(s.stack.length-1)*BH+s.cam,color:ph.c[s.stack.length%ph.c.length],life:1})}
  if(s.sc%10===0&&s.sc>0)sF2("‚Äî "+s.sc+" ‚Äî");
  if(s.sc>=s.puN&&!s.pu&&!s.shield){const pu=PUS[Math.floor(Math.random()*PUS.length)];if(pu.id==="shield"){s.shield=true;s.puN=s.sc+Math.floor(Math.random()*12)+10}else if(pu.id==="freeze"){s.frozen=60;s.puN=s.sc+Math.floor(Math.random()*10)+8}else{s.pu=pu.id;s.puT=pu.id==="slow"?8:pu.id==="magnet"?5:1;s.puN=s.sc+Math.floor(Math.random()*10)+7}$("dPu").textContent=pu.l;$("dPu").style.background=pu.bg;$("dPu").style.border="1px solid "+pu.bd;$("dPu").style.color=pu.c;$("dPu").classList.add("on");sPu()}
  if(s.pu){s.puT--;if(s.puT<=0){s.pu=null;$("dPu").classList.remove("on")}}
  spn(s);if(perf&&s.co>=2)s.mov.w=Math.min(s.stack[s.stack.length-1].w+s.co*1.2,BW*1.3);
}

function mP(s,t){for(let i=0;i<14;i++)s.pts.push({x:t.x+t.w/2+(Math.random()-0.5)*t.w*0.8,y:H-50-(s.stack.length-1)*BH+s.cam,vx:(Math.random()-0.5)*6,vy:-Math.random()*5-2,life:1,color:s.mov?s.mov.color:"#fff",sz:Math.random()*3.5+1.5})}
function sF2(t){$("dFl").textContent=t;$("dFl").classList.add("on");clearTimeout(sF2._t);sF2._t=setTimeout(()=>$("dFl").classList.remove("on"),320)}
let pAT=null;function shPA(ph){$("dPAN").textContent=ph.n;$("dPAN").style.textShadow="0 0 35px "+ph.c[0];$("dPAS").textContent=ph.s;$("dPA").classList.add("on");if(pAT)clearTimeout(pAT);pAT=setTimeout(()=>$("dPA").classList.remove("on"),1400)}

function eG(s){
  const xp=s.sc*10+s.pf*5+s.mc*8;const nw=s.sc>D.bs;
  D.gp++;D.ts+=s.sc;D.tp+=s.pf;D.xp+=xp;if(s.sc>D.bs)D.bs=s.sc;if(s.mc>D.bc)D.bc=s.mc;
  const nA=[];ACHS.forEach(a=>{if(!D.ach.includes(a.id)&&a.ck(D)){D.ach.push(a.id);nA.push(a)}});sv(D);
  $("gSc").textContent=s.sc;$("gBs").textContent="Best: "+D.bs;$("gCo").textContent=s.mc;$("gPf").textContent=s.pf;$("gGp").textContent=D.gp;$("gXp").innerHTML="+<span>"+xp+"</span> XP";$("dBs").textContent=D.bs;$("gPh").textContent="Reached: "+gP(s.sc).n;
  if(nw&&s.sc>0)$("gNw").classList.remove("hide");else $("gNw").classList.add("hide");
  $("dCo").classList.remove("on");$("dPu").classList.remove("on");$("tapLayer").style.display="none";
  setTimeout(()=>$("ovG").classList.remove("hide"),400);
  nA.forEach((a,i)=>setTimeout(()=>shAc(a),600+i*2000));
}

let acTO=null;function shAc(a){$("dAcI").textContent=a.i;$("dAcN").textContent=a.n;$("dAc").classList.add("on");if(acTO)clearTimeout(acTO);acTO=setTimeout(()=>$("dAc").classList.remove("on"),2300);tn(523,0.07,0.05);setTimeout(()=>tn(784,0.1,0.06),120)}

function oP(){$("ovPr").classList.remove("hide");$("ovS").classList.add("hide");$("ovG").classList.add("hide");$("ovGd").classList.add("hide");$("tapLayer").style.display="none";rP()}
function cP(){$("ovPr").classList.add("hide");if(run&&S&&!S.over){$("hud").style.display="flex";$("tapLayer").style.display="block"}else $("ovS").classList.remove("hide")}
function oGd(){$("ovGd").classList.remove("hide");$("ovS").classList.add("hide");$("tapLayer").style.display="none"}
function cGd(){$("ovGd").classList.add("hide");$("ovS").classList.remove("hide")}

function rP(){
  const l=gLv(D.xp),p=gLvP(D.xp);
  $("pAv").textContent=D.name==="Guest"?"?":D.name[0].toUpperCase();$("pNm").textContent=D.name;$("pLv").textContent="Level "+l;$("pXp").style.width=Math.round(p*100)+"%";$("pNI").value=D.name==="Guest"?"":D.name;
  $("s1").textContent=D.bs;$("s2").textContent=D.gp;$("s3").textContent=D.tp;$("s4").textContent=D.bc;$("s5").textContent=D.gp?Math.round(D.ts/D.gp):0;$("s6").textContent=D.xp;
  const ag=$("aG");ag.innerHTML="";ACHS.forEach(a=>{const u=D.ach.includes(a.id);ag.innerHTML+=`<div class="ar ${u?"":"lk"}"><div style="font-size:16px;flex-shrink:0">${a.i}</div><div style="flex:1"><div style="color:#fff;font-size:10px;font-weight:bold">${a.n}</div><div style="color:rgba(255,255,255,0.2);font-size:8px;margin-top:1px">${a.d}</div></div>${u?'<div style="color:#51CF66;font-size:12px">‚úì</div>':""}</div>`});
  const sim=[{n:"StackMaster",s:94},{n:"NeonDrop",s:71},{n:"BlockKing",s:58},{n:"TapQueen",s:47},{n:"SwiftStack",s:35}];
  const all=[...sim.map(p=>({name:p.n,score:p.s})),{name:D.name,score:D.bs,you:true}].sort((a,b)=>b.score-a.score);
  const ll=$("lL");ll.innerHTML="";all.forEach((p,i)=>{const r=i+1,rc=r===1?"color:#FFC53D":r===2?"color:#C0C0C0":r===3?"color:#CD7F32":"color:rgba(255,255,255,0.2)";ll.innerHTML+=`<div class="lr ${p.you?"you":""}"><div style="font-size:12px;font-weight:bold;width:20px;text-align:center;${rc}">${r}</div><div style="flex:1;color:${p.you?"#FF6B6B":"rgba(255,255,255,0.5)"};font-size:11px">${p.name}${p.you?" (You)":""}</div><div style="color:rgba(255,255,255,0.35);font-size:12px;font-weight:bold">${p.score}</div></div>`});
}
function uAv(){$("bPr").textContent=D.name==="Guest"?"?":D.name[0].toUpperCase()}

function shareG(){const u=window.location.href;const t="üèóÔ∏è STACK ‚Äî An addictive game that transforms as you climb higher. 10 phases, power-ups, and a global leaderboard.\n\nPlay: "+u+"\n\nby bbmw0";if(navigator.share)navigator.share({title:"STACK ‚Äî by bbmw0",text:"üèóÔ∏è STACK ‚Äî How high can you stack? 10 phases, power-ups, and a leaderboard. Try it!",url:u}).catch(()=>{});else{navigator.clipboard.writeText(t).then(()=>alert("Link copied!")).catch(()=>{})}}
function shareS(){const sc=S?S.sc:0,ph=S?gP(S.sc).n:"";const u=window.location.href;const t="üèóÔ∏è STACK ‚Äî I scored "+sc+"! Reached "+ph+"\nBest: "+D.bs+" | Level "+gLv(D.xp)+"\n\nPlay: "+u+"\nby bbmw0";if(navigator.share)navigator.share({title:"STACK: "+sc+" points!",text:t,url:u}).catch(()=>{});else{navigator.clipboard.writeText(t).then(()=>alert("Copied!")).catch(()=>{})}}

// ‚ïê‚ïê‚ïê DRAW ‚ïê‚ïê‚ïê
function rr(c,x,y,w,h,r){c.beginPath();c.moveTo(x+r,y);c.lineTo(x+w-r,y);c.quadraticCurveTo(x+w,y,x+w,y+r);c.lineTo(x+w,y+h-r);c.quadraticCurveTo(x+w,y+h,x+w-r,y+h);c.lineTo(x+r,y+h);c.quadraticCurveTo(x,y+h,x,y+h-r);c.lineTo(x,y+r);c.quadraticCurveTo(x,y,x+r,y);c.closePath()}

function loop(){
  if(!S){aId=null;return}const s=S;tk++;
  if(!s.over&&s.mov){
    if(s.frozen>0){s.frozen--;if(s.frozen<=0)$("dPu").classList.remove("on")}
    else{
      let sp=s.mov.speed;if(s.pu==="slow")sp*=0.4;
      s.mov.x+=s.mov.dir*sp;
      if(s.mov.x+s.mov.w>W+30)s.mov.dir=-1;if(s.mov.x<-30)s.mov.dir=1;
      if(s.mov.mirrorCd>0){s.mov.mirrorCd--;if(s.mov.mirrorCd<=0&&gP(s.sc).mirror){s.mov.dir*=-1;s.mov.mirrorCd=Math.floor(Math.random()*25)+12}}
    }
  }
  const tc=Math.max(0,(s.stack.length-Math.floor(H/BH*0.55))*BH);s.cam+=(tc-s.cam)*0.06;
  s.fall=s.fall.filter(f=>{f.vy+=GR;f.y+=f.vy;f.rot+=(f.vr||0);return f.y<H+200});
  s.pts=s.pts.filter(p=>{p.x+=p.vx;p.y+=p.vy;p.vy+=0.12;p.life-=0.02;return p.life>0});
  s.fire=s.fire.filter(f=>{f.x+=f.vx;f.y+=f.vy;f.life-=0.025;return f.life>0});
  s.trails=s.trails.filter(t=>{t.life-=0.013;return t.life>0});
  if(s.fl>0)s.fl--;if(s.shk>0)s.shk*=0.8;
  stars.forEach(st=>{st.b+=st.sp;if(st.b>1)st.b=0});

  const ph=gP(s.sc);
  ctx.save();
  if(s.shk>0.5)ctx.translate((Math.random()-0.5)*s.shk,(Math.random()-0.5)*s.shk*0.4);
  ctx.clearRect(-10,-10,W+20,H+20);
  const bg=ctx.createLinearGradient(0,0,0,H);bg.addColorStop(0,ph.bg1);bg.addColorStop(1,ph.bg2);ctx.fillStyle=bg;ctx.fillRect(0,0,W,H);
  for(const st of stars){ctx.fillStyle=`rgba(255,255,255,${0.2+Math.sin(st.b*Math.PI*2)*0.3})`;ctx.beginPath();ctx.arc(st.x,st.y,st.s,0,Math.PI*2);ctx.fill()}
  const ga=Math.max(0.006,0.02-s.sc*0.0002);ctx.strokeStyle=`rgba(255,255,255,${ga})`;ctx.lineWidth=1;for(let gx=0;gx<W;gx+=30){ctx.beginPath();ctx.moveTo(gx,0);ctx.lineTo(gx,H);ctx.stroke()}
  const bY=H-50;
  for(const t of s.trails){ctx.save();ctx.globalAlpha=t.life*0.25;ctx.fillStyle=t.color;ctx.shadowColor=t.color;ctx.shadowBlur=16;ctx.fillRect(t.x,t.y,t.w,BH-2);ctx.restore()}
  for(let i=0;i<s.stack.length;i++){const b=s.stack[i],y=bY-i*BH+s.cam;if(y>H+BH||y<-BH*2)continue;ctx.fillStyle=b.color;ctx.shadowColor=b.color;ctx.shadowBlur=ph.gl;rr(ctx,b.x,y,b.w,BH-2,3);ctx.fill();ctx.shadowBlur=0;ctx.fillStyle="rgba(255,255,255,0.09)";ctx.fillRect(b.x,y,b.w,BH*0.25);if(i===s.stack.length-1&&b.w<BW*0.26&&!s.over){ctx.shadowColor="#FF0000";ctx.shadowBlur=18+Math.sin(tk*0.15)*6;ctx.strokeStyle="rgba(255,50,50,0.2)";ctx.lineWidth=2;rr(ctx,b.x,y,b.w,BH-2,3);ctx.stroke();ctx.shadowBlur=0}}
  if(s.shield&&s.stack.length>0){const top=s.stack[s.stack.length-1],ty=bY-(s.stack.length-1)*BH+s.cam;ctx.strokeStyle="rgba(255,197,61,"+(0.25+Math.sin(tk*0.07)*0.12)+")";ctx.lineWidth=2;ctx.setLineDash([4,4]);rr(ctx,top.x-3,ty-3,top.w+6,BH+4,5);ctx.stroke();ctx.setLineDash([])}
  if(!s.over&&s.mov){const my=bY-s.stack.length*BH+s.cam,m=s.mov;ctx.fillStyle=m.color;ctx.shadowColor=s.pu==="slow"?"#339AF0":s.pu==="magnet"?"#E599F7":m.color;ctx.shadowBlur=ph.gl+4;rr(ctx,m.x,my,m.w,BH-2,3);ctx.fill();ctx.shadowBlur=0;ctx.fillStyle="rgba(255,255,255,0.13)";ctx.fillRect(m.x,my,m.w,BH*0.25);
    if(!ph.noGuide){const top=s.stack[s.stack.length-1];ctx.setLineDash([3,4]);ctx.strokeStyle="rgba(255,255,255,0.05)";ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(top.x,my-10);ctx.lineTo(top.x,my+BH+6);ctx.stroke();ctx.beginPath();ctx.moveTo(top.x+top.w,my-10);ctx.lineTo(top.x+top.w,my+BH+6);ctx.stroke();ctx.setLineDash([])}}
  for(const f of s.fall){const fy=bY-s.stack.length*BH+s.cam+f.y;ctx.save();ctx.globalAlpha=Math.max(0,1-f.y/300);ctx.translate(f.x+f.w/2,fy+BH/2);ctx.rotate(f.rot||0);ctx.fillStyle=f.color;ctx.fillRect(-f.w/2,-BH/2+1,f.w,BH-2);ctx.restore()}
  for(const p of s.pts){ctx.save();ctx.globalAlpha=p.life;ctx.fillStyle=p.color;ctx.shadowColor=p.color;ctx.shadowBlur=4;ctx.beginPath();ctx.arc(p.x,p.y,p.sz*p.life,0,Math.PI*2);ctx.fill();ctx.restore()}
  for(const f of s.fire){ctx.save();ctx.globalAlpha=f.life*0.6;const gr=ctx.createRadialGradient(f.x,f.y,0,f.x,f.y,f.sz*f.life);gr.addColorStop(0,"#FFC53D");gr.addColorStop(0.6,"#FF6B6B");gr.addColorStop(1,"transparent");ctx.fillStyle=gr;ctx.beginPath();ctx.arc(f.x,f.y,f.sz*f.life,0,Math.PI*2);ctx.fill();ctx.restore()}
  if(s.fl>0){ctx.save();ctx.globalAlpha=(s.fl/20)*0.08;ctx.fillStyle="#fff";ctx.fillRect(0,0,W,H);ctx.restore()}
  ctx.restore();aId=requestAnimationFrame(loop);
}

// ‚ïê‚ïê‚ïê EVENTS ‚ïê‚ïê‚ïê
$("tapLayer").addEventListener("touchstart",function(e){e.preventDefault();tap()},{passive:false});
$("tapLayer").addEventListener("mousedown",function(e){e.preventDefault();tap()});

$("ovS").addEventListener("touchstart",function(e){if(e.target.tagName==="BUTTON"||e.target.closest("button"))return;e.preventDefault();startG()},{passive:false});
$("ovS").addEventListener("mousedown",function(e){if(e.target.tagName==="BUTTON"||e.target.closest("button"))return;e.preventDefault();startG()});
$("startC").addEventListener("touchstart",function(e){e.preventDefault();e.stopPropagation();startG()},{passive:false});
$("startC").addEventListener("click",function(e){e.stopPropagation();startG()});

document.addEventListener("keydown",function(e){if(e.code!=="Space")return;e.preventDefault();if(!$("ovS").classList.contains("hide"))startG();else if(run&&S&&!S.over)tap()});

function btn(id,fn){$(id).addEventListener("click",function(e){e.stopPropagation();fn()});$(id).addEventListener("touchstart",function(e){e.preventDefault();e.stopPropagation();fn()},{passive:false})}

btn("bRe",startG);btn("bHo",goH);btn("bSS",shareS);btn("bSL",shareG);btn("bNP",oP);btn("bNG",oGd);btn("bPr",oP);btn("bPrX",cP);btn("bGdX",cGd);
btn("bNS",function(){const v=$("pNI").value.trim();if(v){D.name=v;sv(D);rP();uAv()}});
["bG","bA","bL"].forEach(function(id){btn(id,function(){alert("Sign-in requires a backend server.\nSee DEPLOY.md for instructions.")})});
btn("bRst",function(){if(confirm("Reset all data?")){D={...DEF};sv(D);rP();uAv()}});
btn("bCof",function(){window.location.href="https://buymeacoffee.com/bbmw0"});

document.addEventListener("dblclick",function(e){e.preventDefault()});
uAv();$("dBs").textContent=D.bs;
})();
</script>
<script>
if('serviceWorker' in navigator){navigator.serviceWorker.register('/sw.js').catch(()=>{})}
</script>
</body>
</html>
